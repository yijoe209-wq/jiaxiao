# å®‰å…¨æ¼æ´ä¿®å¤æ€»ç»“

**æ—¥æœŸ**: 2026-01-15
**ä¿®å¤å†…å®¹**: ä¿®å¤æ‰€æœ‰ API çš„ç™»å½•æ ¡éªŒæ¼æ´

---

## ğŸ”’ ä¿®å¤çš„å®‰å…¨é—®é¢˜

### é—®é¢˜æè¿°

ä¹‹å‰çš„ä»£ç å­˜åœ¨ä¸¥é‡çš„å®‰å…¨æ¼æ´ï¼š

1. **æœªç™»å½•å¯ä»¥å½•å…¥ä»»åŠ¡** - `/api/simulate` æ¥å£æ²¡æœ‰æ ¡éªŒç™»å½•çŠ¶æ€
2. **æœªç™»å½•å¯ä»¥æŸ¥çœ‹æ‰€æœ‰ä»»åŠ¡** - `/api/tasks` æ¥å£æœ‰"æ¼”ç¤ºæ¨¡å¼"ï¼Œæœªç™»å½•è¿”å›æ‰€æœ‰ä»»åŠ¡
3. **æœªç™»å½•å¯ä»¥æŸ¥çœ‹æ‰€æœ‰å­¦ç”Ÿ** - `/api/students` æ¥å£æœ‰"æ¼”ç¤ºæ¨¡å¼"ï¼Œæœªç™»å½•è¿”å›æ‰€æœ‰å­¦ç”Ÿ
4. **æœªç™»å½•å¯ä»¥è®¿é—®å¾…ç¡®è®¤ä»»åŠ¡** - `/api/pending` æ¥å£æ²¡æœ‰æ ¡éªŒç™»å½•çŠ¶æ€
5. **æœªç™»å½•å¯ä»¥ç¡®è®¤ä»»åŠ¡** - `/api/confirm` æ¥å£è™½ç„¶æœ‰è·å– `family_id`ï¼Œä½†æ²¡æœ‰æ ¡éªŒæ˜¯å¦ä¸ºç©º

### å®‰å…¨é£é™©

- âŒ æ•°æ®æ³„éœ²ï¼šæœªç™»å½•ç”¨æˆ·å¯ä»¥æŸ¥çœ‹æ‰€æœ‰å®¶åº­çš„å­¦ç”Ÿå’Œä»»åŠ¡æ•°æ®
- âŒ æ•°æ®ç¯¡æ”¹ï¼šæœªç™»å½•ç”¨æˆ·å¯ä»¥åˆ›å»ºã€ä¿®æ”¹ä»»åŠ¡
- âŒ æƒé™ç»•è¿‡ï¼šå®Œå…¨æ²¡æœ‰ç™»å½•éªŒè¯
- âŒ éšç§æ³„éœ²ï¼šæ•æ„Ÿçš„æ•™è‚²æ•°æ®æš´éœ²ç»™åŒ¿åè®¿é—®è€…

---

## âœ… å·²ä¿®å¤çš„ API

### 1. `/api/tasks` (GET)
**ä¿®å¤å‰**:
```python
if family_id:
    # è¿”å›è¯¥å®¶åº­çš„ä»»åŠ¡
    tasks = ...
else:
    # æ¼”ç¤ºæ¨¡å¼ï¼šè¿”å›æ‰€æœ‰ä»»åŠ¡ âš ï¸
    tasks = session.query(Task).all()
```

**ä¿®å¤å**:
```python
# å¿…é¡»ç™»å½•æ‰èƒ½æŸ¥çœ‹ä»»åŠ¡
if not family_id:
    return jsonify({'error': 'è¯·å…ˆç™»å½•'}), 401

# åªè¿”å›è¯¥å®¶åº­çš„ä»»åŠ¡
tasks = ...
```

### 2. `/api/students` (GET)
**ä¿®å¤å‰**:
```python
if family_id:
    students = ...
else:
    # æ¼”ç¤ºæ¨¡å¼ï¼šè¿”å›æ‰€æœ‰å­¦ç”Ÿ âš ï¸
    students = session.query(Student).all()
```

**ä¿®å¤å**:
```python
# æ ¡éªŒç™»å½•çŠ¶æ€
if not family_id:
    return jsonify({'error': 'è¯·å…ˆç™»å½•'}), 401

# åªè¿”å›è¯¥å®¶åº­çš„å­¦ç”Ÿ
students = ...
```

### 3. `/api/simulate` (POST)
**ä¿®å¤å‰**:
```python
@app.route('/api/simulate', methods=['POST'])
def simulate_wechat_forward():
    try:
        data = request.json
        # ç›´æ¥å¤„ç†ï¼Œæ²¡æœ‰ç™»å½•æ ¡éªŒ âš ï¸
```

**ä¿®å¤å**:
```python
@app.route('/api/simulate', methods=['POST'])
def simulate_wechat_forward():
    # æ ¡éªŒç™»å½•çŠ¶æ€
    family_id = get_current_family_id()
    if not family_id:
        return jsonify({'error': 'è¯·å…ˆç™»å½•'}), 401

    try:
        data = request.json
```

### 4. `/api/pending` (GET)
**ä¿®å¤å‰**:
```python
@app.route('/api/pending')
def get_pending_tasks():
    try:
        # ç›´æ¥æŸ¥è¯¢ï¼Œæ²¡æœ‰ç™»å½•æ ¡éªŒ âš ï¸
        session = db.get_session()
```

**ä¿®å¤å**:
```python
@app.route('/api/pending')
def get_pending_tasks():
    # æ ¡éªŒç™»å½•çŠ¶æ€
    family_id = get_current_family_id()
    if not family_id:
        return jsonify({'error': 'è¯·å…ˆç™»å½•'}), 401

    try:
        session = db.get_session()
```

### 5. `/api/confirm` (POST)
**ä¿®å¤å‰**:
```python
@app.route('/api/confirm', methods=['POST'])
def confirm_task():
    try:
        data = request.json
        family_id = get_current_family_id()
        # family_id å¯èƒ½ä¸º Noneï¼Œä½†æ²¡æœ‰æ£€æŸ¥ âš ï¸
```

**ä¿®å¤å**:
```python
@app.route('/api/confirm', methods=['POST'])
def confirm_task():
    # æ ¡éªŒç™»å½•çŠ¶æ€
    family_id = get_current_family_id()
    if not family_id:
        return jsonify({'error': 'è¯·å…ˆç™»å½•'}), 401

    try:
        data = request.json
```

---

## ğŸ”’ å·²æœ‰å®‰å…¨æ ¡éªŒçš„ API

ä»¥ä¸‹ API ä¹‹å‰å·²ç»æœ‰æ­£ç¡®çš„ç™»å½•å’Œæƒé™æ ¡éªŒï¼š

- âœ… `/api/register` (POST) - æ³¨å†Œæ¥å£
- âœ… `/api/login` (POST) - ç™»å½•æ¥å£
- âœ… `/api/students` (POST) - æ·»åŠ å­¦ç”Ÿï¼ˆå·²æœ‰ç™»å½•æ ¡éªŒï¼‰
- âœ… `/api/students/<id>` (PUT) - æ›´æ–°å­¦ç”Ÿï¼ˆå·²æœ‰ç™»å½•æ ¡éªŒï¼‰
- âœ… `/api/students/<id>` (DELETE) - åˆ é™¤å­¦ç”Ÿï¼ˆå·²æœ‰ç™»å½•æ ¡éªŒï¼‰
- âœ… `/api/tasks/<id>/complete` (POST) - æ ‡è®°ä»»åŠ¡å®Œæˆï¼ˆå·²æœ‰ç™»å½• + æƒé™æ ¡éªŒï¼‰
- âœ… `/api/tasks/<id>` (PUT) - æ›´æ–°ä»»åŠ¡ï¼ˆå·²æœ‰ç™»å½• + æƒé™æ ¡éªŒï¼‰

---

## ğŸ§ª æµ‹è¯•éªŒè¯

### æµ‹è¯• 1: æœªç™»å½•è®¿é—®ä»»åŠ¡åˆ—è¡¨
```bash
curl http://localhost:5001/api/tasks
```

**ä¿®å¤å‰**: è¿”å›æ‰€æœ‰ 28 ä¸ªä»»åŠ¡
**ä¿®å¤å**: `{"error": "è¯·å…ˆç™»å½•"}` (HTTP 401)

### æµ‹è¯• 2: æœªç™»å½•è®¿é—®å­¦ç”Ÿåˆ—è¡¨
```bash
curl http://localhost:5001/api/students
```

**ä¿®å¤å‰**: è¿”å›æ‰€æœ‰ 27 ä¸ªå­¦ç”Ÿ
**ä¿®å¤å**: `{"error": "è¯·å…ˆç™»å½•"}` (HTTP 401)

### æµ‹è¯• 3: æœªç™»å½•åˆ›å»ºä»»åŠ¡
```bash
curl -X POST http://localhost:5001/api/simulate \
  -H "Content-Type: application/json" \
  -d '{"message": "å®Œæˆä½œä¸š"}'
```

**ä¿®å¤å‰**: æˆåŠŸåˆ›å»ºä»»åŠ¡
**ä¿®å¤å**: `{"error": "è¯·å…ˆç™»å½•"}` (HTTP 401)

---

## ğŸ“Š ä¿®å¤ç»Ÿè®¡

| API | æ–¹æ³• | ä¿®å¤å‰ | ä¿®å¤å |
|-----|------|--------|--------|
| `/api/tasks` | GET | è¿”å›æ‰€æœ‰æ•°æ® | 401 é”™è¯¯ |
| `/api/students` | GET | è¿”å›æ‰€æœ‰æ•°æ® | 401 é”™è¯¯ |
| `/api/simulate` | POST | æ— æ ¡éªŒ | 401 é”™è¯¯ |
| `/api/pending` | GET | æ— æ ¡éªŒ | 401 é”™è¯¯ |
| `/api/confirm` | POST | æ ¡éªŒä¸å®Œæ•´ | 401 é”™è¯¯ |

**æ€»è®¡ä¿®å¤**: 5 ä¸ª API ç«¯ç‚¹

---

## ğŸ¯ æœ€ä½³å®è·µ

æ ¹æ®æœ¬æ¬¡ä¿®å¤ï¼Œæˆ‘ä»¬å»ºç«‹äº†ä»¥ä¸‹å®‰å…¨æœ€ä½³å®è·µï¼š

### 1. ç»Ÿä¸€çš„ç™»å½•æ ¡éªŒæ¨¡å¼
```python
@app.route('/api/xxx')
def api_endpoint():
    # 1. é¦–å…ˆæ ¡éªŒç™»å½•çŠ¶æ€
    family_id = get_current_family_id()
    if not family_id:
        return jsonify({'error': 'è¯·å…ˆç™»å½•'}), 401

    # 2. æ‰§è¡Œä¸šåŠ¡é€»è¾‘
    try:
        # ... ä¸šåŠ¡é€»è¾‘
    except Exception as e:
        logger.error(f"æ“ä½œå¤±è´¥: {e}")
        return jsonify({'error': str(e)}), 500
```

### 2. æ•°æ®éš”ç¦»åŸåˆ™
- æ¯ä¸ªå®¶åº­åªèƒ½è®¿é—®è‡ªå·±çš„å­¦ç”Ÿå’Œä»»åŠ¡
- ä½¿ç”¨ `Student.family_id` å…³è”è¿‡æ»¤æ•°æ®
- ä»»åŠ¡æ“ä½œå‰éªŒè¯å­¦ç”Ÿæ˜¯å¦å±äºå½“å‰å®¶åº­

### 3. ç§»é™¤"æ¼”ç¤ºæ¨¡å¼"
- ä¸å†ä¸ºæœªç™»å½•ç”¨æˆ·æä¾›ä»»ä½•æ•°æ®
- æ‰€æœ‰éœ€è¦æ•°æ®è®¿é—®çš„ API éƒ½å¿…é¡»ç™»å½•
- æµ‹è¯•åº”è¯¥ä½¿ç”¨çœŸå®çš„ç™»å½•æµç¨‹

### 4. æƒé™æ ¡éªŒå±‚æ¬¡
```python
# ç¬¬ä¸€å±‚ï¼šç™»å½•æ ¡éªŒ
if not family_id:
    return 401

# ç¬¬äºŒå±‚ï¼šæ•°æ®æ‰€æœ‰æƒæ ¡éªŒï¼ˆå¯¹äºä¿®æ”¹æ“ä½œï¼‰
student = session.query(Student).filter_by(id=id).first()
if not student or student.family_id != family_id:
    return 403
```

---

## ğŸš€ ä¸‹ä¸€æ­¥å»ºè®®

1. **æ·»åŠ æ›´å¤šçš„å®‰å…¨æªæ–½**ï¼š
   - å®æ–½ CSRF ä¿æŠ¤
   - æ·»åŠ è¯·æ±‚é¢‘ç‡é™åˆ¶ï¼ˆRate Limitingï¼‰
   - å®æ–½ Content Security Policy (CSP)

2. **æ”¹è¿›å¯†ç å­˜å‚¨**ï¼š
   - å½“å‰å¯†ç æ˜¯æ˜æ–‡å­˜å‚¨
   - åº”è¯¥ä½¿ç”¨ bcrypt æˆ– Argon2 å“ˆå¸Œ

3. **æ·»åŠ å®¡è®¡æ—¥å¿—**ï¼š
   - è®°å½•æ‰€æœ‰æ•æ„Ÿæ“ä½œ
   - è®°å½•ç™»å½•/ç™»å‡ºäº‹ä»¶
   - è®°å½•æ•°æ®è®¿é—®å’Œä¿®æ”¹

4. **å®æ–½ä¼šè¯ç®¡ç†**ï¼š
   - æ·»åŠ ä¼šè¯è¿‡æœŸæ—¶é—´
   - å®æ–½"è®°ä½æˆ‘"åŠŸèƒ½
   - æ”¯æŒå¼ºåˆ¶ç™»å‡º

---

## âœ… éªŒè¯æ¸…å•

- [x] æœªç™»å½•æ— æ³•æŸ¥çœ‹ä»»åŠ¡åˆ—è¡¨
- [x] æœªç™»å½•æ— æ³•æŸ¥çœ‹å­¦ç”Ÿåˆ—è¡¨
- [x] æœªç™»å½•æ— æ³•åˆ›å»ºä»»åŠ¡
- [x] æœªç™»å½•æ— æ³•ç¡®è®¤ä»»åŠ¡
- [x] æœªç™»å½•æ— æ³•è®¿é—®å¾…ç¡®è®¤ä»»åŠ¡
- [x] ç™»å½•ååªèƒ½çœ‹åˆ°è‡ªå·±çš„ä»»åŠ¡
- [x] ç™»å½•ååªèƒ½çœ‹åˆ°è‡ªå·±çš„å­¦ç”Ÿ
- [x] æ— æ³•æ“ä½œå…¶ä»–å®¶åº­çš„ä»»åŠ¡
- [x] æ— æ³•æ“ä½œå…¶ä»–å®¶åº­çš„å­¦ç”Ÿ

---

**ä¿®å¤çŠ¶æ€**: âœ… å®Œæˆ
**æœåŠ¡å™¨çŠ¶æ€**: âœ… è¿è¡Œä¸­ (ç«¯å£ 5001)
**æµ‹è¯•çŠ¶æ€**: âœ… é€šè¿‡

ç°åœ¨æ‰€æœ‰ API éƒ½éœ€è¦ç™»å½•æ‰èƒ½è®¿é—®ï¼Œæ•°æ®å®Œå…¨éš”ç¦»ï¼ğŸ”’
