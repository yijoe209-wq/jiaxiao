<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ç¼–è¾‘ä»»åŠ¡ - å®¶æ ¡ä»»åŠ¡åŠ©æ‰‹</title>

    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>

    <!-- Google Fonts: Noto Sans SC + Inter -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+SC:wght@300;400;500;700&family=Inter:wght@400;500;600&display=swap" rel="stylesheet">

    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: {
                        sans: ['"Noto Sans SC"', '"Inter"', 'sans-serif'],
                    },
                    colors: {
                        zen: {
                            bg: '#ffffff',
                            text: '#1a1a1a',
                            textLight: '#999999',
                            border: '#f0f0f0',
                            borderLight: '#e5e5e5',
                            accent: '#1a1a1a',
                        }
                    }
                }
            }
        }
    </script>

    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Noto Sans SC', 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
            background: #fafafa;
            color: #1a1a1a;
            line-height:1.6;
            -webkit-font-smoothing: antialiased;
        }

        /* é¡µé¢å®¹å™¨ */
        .container {
            max-width: 672px;
            margin: 0 auto;
            padding: 20px;
        }

        /* å¤´éƒ¨å¯¼èˆª */
        .header {
            background: var(--zen-text);
            color: white;
            padding: 16px 20px;
            border-radius: 16px;
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .header h1 {
            font-size: 18px;
            font-weight: 500;
            margin: 0;
        }

        /* è¿”å›æŒ‰é’® */
        .back-link {
            color: white;
            text-decoration: none;
            font-size: 14px;
        }

        /* å¡ç‰‡æ ·å¼ */
        .card {
            background: white;
            border-radius: 16px;
            padding: 24px;
            margin-bottom: 20px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        }

        /* è¡¨å•æ ·å¼ */
        .form-group {
            margin-bottom: 20px;
        }

        .form-label {
            display: block;
            margin-bottom: 8px;
            font-size: 14px;
            font-weight: 500;
            color: #1a1a1a;
        }

        .form-input {
            width: 100%;
            padding: 12px 16px;
            border: 1px solid #e5e5e5;
            border-radius: 8px;
            font-size: 14px;
            background: #fff;
            transition: all 0.2s ease;
        }

        .form-input:focus {
            outline: none;
            border-color: #1a1a1a;
        }

        textarea.form-input {
            resize: vertical;
            min-height: 100px;
        }

        /* æŒ‰é’®æ ·å¼ */
        .btn-primary {
            background: #1a1a1a;
            color: white;
            padding: 12px 24px;
            border-radius: 12px;
            font-size: 14px;
            font-weight: 500;
            border: none;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .btn-primary:hover {
            background: #333;
        }

        .btn-secondary {
            background: white;
            color: #1a1a1a;
            padding: 12px 24px;
            border-radius: 12px;
            font_size: 14px;
            font-weight: 500;
            border: 1px solid #e5e5e5;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .btn-secondary:hover {
            border-color: #1a1a1a;
            background: #fafafa;
        }

        .btn-danger {
            background: #ef4444;
            color: white;
            padding: 12px 24px;
            border-radius: 12px;
            font_size: 14px;
            font-weight: 500;
            border: none;
            cursor: pointer;
        }

        .btn-danger:hover {
            background: #dc2626;
        }

        /* æç¤ºä¿¡æ¯ */
        .alert {
            background: #fef3c7;
            border: 1px solid #d66b0f;
            border-radius: 8px;
            padding: 12px 16px;
            margin-bottom: 20px;
            font-size: 14px;
        }

        .alert-info {
            background: #dbeafe;
            border-color: #b4f8ff;
        }

        .alert-warning {
            background: #fef3c7;
            border-color: #d66b0f;
        }

        .alert-info {
            background: #dbeafe;
            border-color: #b4f8ff;
            color: #1a1a1a;
        }
    </style>
</head>
<body class="bg-gray-50">
    <div class="container">
        <!-- é¡µé¢å¯¼èˆª -->
        <div class="header">
            <a href="/" class="back-link">â† è¿”å›ä»»åŠ¡ä¸­å¿ƒ</a>
            <h1>ç¼–è¾‘ä»»åŠ¡</h1>
            <span style="width: 60px;"></span>
        </div>

        <!-- åŠ è½½æç¤º -->
        <div id="loading" style="display:none; text-align:center; padding:40px;">
            <div class="alert alert-info">åŠ è½½ä¸­...</div>
        </div>

        <!-- ç¼–è¾‘è¡¨å• -->
        <div id="editForm" style="display:none;">
            <input type="hidden" id="taskId">

            <div class="card">
                <form id="taskForm" onsubmit="handleSubmit(event)">
                    <!-- ä»»åŠ¡æè¿° -->
                    <div class="form-group">
                        <label class="form-label">ä»»åŠ¡æè¿°</label>
                        <textarea id="description" class="form-input" rows="3" required></textarea>
                    </div>

                    <!-- ç§‘ç›® -->
                    <div class="form-group">
                        <label class="form-label">ç§‘ç›®</label>
                        <select id="subject" class="form-input">
                            <option value="">è¯·é€‰æ‹©ç§‘ç›®</option>
                            <option value="è¯­æ–‡">è¯­æ–‡</option>
                            <option value="æ•°å­¦">æ•°å­¦</option>
                            <option value="è‹±è¯­">è‹±è¯­</option>
                            <option value="æ”¿æ²»">æ”¿æ²»</option>
                            <option value="å†å²">å†å²</option>
                            <option value="åœ°ç†">åœ°ç†</option>
                            <option value="ç”Ÿç‰©">ç”Ÿç‰©</option>
option value="ç§‘å­¦">ç§‘å­¦</option>
                            <option value="ä½“è‚²">ä½“è‚²</option>
                            <option value="éŸ³ä¹">éŸ³ä¹</option>
                            <option value="ç¾æœ¯">ç¾æœ¯</option>
                            <option value="å…¶ä»–">å…¶ä»–</option>
                        </select>
                    </div>

                    <!-- æˆªæ­¢æ—¥æœŸ -->
                    <div class="form-group">
                        <label class="form-label">æˆªæ­¢æ—¥æœŸ</label>
                        <input type="date" id="deadline" class="form-input">
                        <div class="text-sm text-gray-500 mt-1" style="margin-top:4px;">
                            ğŸ’¡ æç¤ºï¼šè¿™æ˜¯ä»»åŠ¡éœ€è¦å®Œæˆçš„æ—¥æœŸ
                        </div>
                    </div>

                    <!-- æ“ä½œæŒ‰é’® -->
                    <div class="flex gap-3">
                        <button type="submit" class="btn-primary">ä¿å­˜ä¿®æ”¹</button>
                        <button type="button" onclick="window.location.href='/'" class="btn-secondary">å–æ¶ˆ</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <script>
        let currentTask = null;

        // é¡µé¢åŠ è½½æ—¶è·å–ä»»åŠ¡ä¿¡æ¯
        async function loadTask() {
            const pathParts = window.location.pathname.split('/');
            const taskId = pathParts[pathParts.length - 1];

            const response = await fetch(`/api/tasks/${taskId}`);
            if (!response.ok) {
                document.getElementById('loading').innerHTML =
                    '<div class="alert alert-warning">ä»»åŠ¡ä¸å­˜åœ¨æˆ–å·²è¢«åˆ é™¤</div>';
                document.getElementById('loading').style.display = 'block';
                return;
            }

            const task = await response.json();
            currentTask = task;

            // å¡«å……è¡¨å•
            document.getElementById('taskId').value = task.task_id;
            document.getElementById('description').value = task.description || '';
            document.getElementById('subject').value = task.subject || '';

            // å¤„ç† deadline (ä» ISO æ ¼å¼è½¬ä¸º date input æ ¼å¼)
            if (task.deadline) {
                const deadline = new Date(task.deadline);
                const year = deadline.getFullYear();
                const month = String(deadline.getMonth() + 1).padStart(2, '0');
                const day = String(deadline.getDate()).padStart(2, '0');
                document.getElementById('deadline').value = `${year}-${month}-${day}`;
            }

            // æ˜¾ç¤ºè¡¨å•
            document.getElementById('loading').style.display = 'none';
            document.getElementById('editForm').style.display = 'block';
        }

        // æäº¤è¡¨å•
        async function handleSubmit(event) {
            event.preventDefault();

            const taskId = document.getElementById('taskId').value;
            const description = document.getElementById('description').value;
            const subject = document.getElementById('subject').value;
            const deadline = document.getElementById('deadline').value;

            const data = {};
            if (description) data.description = description;
            if (subject) data.subject = subject;
            if (deadline) {
                // åªå‘é€æ—¥æœŸéƒ¨åˆ† YYYY-MM-DDï¼Œåç«¯ä¼šè‡ªåŠ¨è®¾ç½®ä¸º23:59:59
                data.deadline = deadline;
            }

            try {
                const response = await fetch(`/api/tasks/${taskId}`, {
                    method: 'PUT',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify(data)
                });

                if (response.ok) {
                    alert('ä»»åŠ¡æ›´æ–°æˆåŠŸï¼');
                    window.location.href = '/';
                } else {
                    const error = await response.json();
                    alert('æ›´æ–°å¤±è´¥ï¼š' + error.error);
                }
            } catch (error) {
                alert('æ›´æ–°å¤±è´¥ï¼š' + error);
            }
        }

        // é¡µé¢åŠ è½½æ—¶æ‰§è¡Œ
        document.addEventListener('DOMContentLoaded', loadTask);
    </script>
</body>
</html>