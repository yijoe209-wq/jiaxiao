<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>确认任务 - 家校任务助手</title>

    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>

    <!-- Google Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+SC:wght@300;400;500;700&family=Inter:wght@400;500;600&display=swap" rel="stylesheet">

    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: {
                        sans: ['"Noto Sans SC"', '"Inter"', 'sans-serif'],
                    }
                }
            }
        }
    </script>

    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Noto Sans SC', 'Inter', sans-serif;
            background: #fafafa;
            color: #1a1a1a;
            line-height: 1.6;
        }

        .task-card {
            background: white;
            border: 2px solid #e5e5e5;
            border-radius: 16px;
            padding: 24px;
            margin-bottom: 24px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
            transition: all 0.3s ease;
        }

        .task-card:hover {
            border-color: #1a1a1a;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
        }

        .task-number {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            width: 32px;
            height: 32px;
            background: #1a1a1a;
            color: white;
            border-radius: 50%;
            font-size: 14px;
            font-weight: 600;
            margin-right: 12px;
        }

        .task-header {
            display: flex;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 16px;
            border-bottom: 2px solid #f0f0f0;
        }

        .task-title {
            font-size: 18px;
            font-weight: 600;
            color: #1a1a1a;
        }

        .btn-primary {
            background: #1a1a1a;
            color: white;
            padding: 14px 28px;
            border-radius: 12px;
            font-size: 16px;
            font-weight: 500;
            border: none;
            cursor: pointer;
            transition: all 0.2s ease;
            width: 100%;
        }

        .btn-primary:hover {
            background: #333;
        }

        .btn-primary:disabled {
            background: #e5e5e5;
            cursor: not-allowed;
        }

        .attachment-img {
            width: 100%;
            max-width: 300px;
            height: auto;
            border-radius: 12px;
            margin-bottom: 12px;
            cursor: pointer;
            transition: transform 0.2s;
        }

        .attachment-img:hover {
            transform: scale(1.02);
        }

        .raw-text {
            background: #f5f5f5;
            border-left: 3px solid #1a1a1a;
            padding: 12px;
            margin: 12px 0;
            font-size: 14px;
            color: #666;
            line-height: 1.8;
            white-space: pre-wrap;
            word-break: break-word;
        }

        .editable-field {
            border: 1px solid #e5e5e5;
            border-radius: 8px;
            padding: 12px;
            margin-bottom: 12px;
            transition: border-color 0.2s;
        }

        .editable-field:focus {
            outline: none;
            border-color: #1a1a1a;
        }

        .editable-label {
            font-size: 13px;
            color: #999;
            margin-bottom: 4px;
        }

        @keyframes slideUp {
            from {
                opacity: 0;
                transform: translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .animate-slide-up {
            animation: slideUp 0.3s ease-out;
        }
    </style>
</head>
<body>
    <div class="max-w-2xl mx-auto px-4 py-8">
        <!-- 页面标题 -->
        <div class="mb-8">
            <h1 class="text-2xl font-medium text-gray-900 mb-2">确认任务信息</h1>
            <p class="text-sm text-gray-500">请核对并确认以下任务</p>
        </div>

        <!-- 学生信息卡片 -->
        <div id="studentInfo" class="task-card mb-6 hidden">
            <div class="flex items-center gap-3">
                <div class="w-10 h-10 bg-gray-100 rounded-full flex items-center justify-center">
                    <svg class="w-5 h-5 text-gray-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"/>
                    </svg>
                </div>
                <div>
                    <p class="text-sm text-gray-500">学生</p>
                    <p id="studentName" class="text-base font-medium text-gray-900"></p>
                </div>
            </div>
        </div>

        <!-- 任务列表 -->
        <div id="taskList" class="mb-6">
            <!-- 任务卡片将动态加载 -->
        </div>

        <!-- 确认按钮 -->
        <div class="fixed bottom-0 left-0 right-0 bg-white border-t border-gray-100 p-4">
            <div class="max-w-2xl mx-auto">
                <button id="confirmBtn" class="btn-primary" onclick="confirmTasks()" disabled>
                    确认创建任务
                </button>
            </div>
        </div>

        <!-- 成功提示 -->
        <div id="successModal" class="fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center z-50">
            <div class="bg-white rounded-3xl p-10 text-center max-w-sm mx-4 animate-slide-up">
                <div class="text-6xl mb-4">✓</div>
                <h2 class="text-2xl font-medium text-gray-900 mb-2">任务创建成功</h2>
                <p id="successText" class="text-gray-500 mb-6">成功创建 1 个任务</p>
                <button onclick="goToTasks()" class="btn-primary">
                    查看任务
                </button>
            </div>
        </div>

        <!-- 加载状态 -->
        <div id="loadingState" class="text-center py-20">
            <div class="text-gray-300 mb-4">加载中...</div>
        </div>

        <!-- 错误状态 -->
        <div id="errorState" class="text-center py-20 hidden">
            <div class="text-gray-300 mb-4">
                <svg class="w-12 h-12 mx-auto" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"/>
                </svg>
            </div>
            <p class="text-gray-500 mb-4" id="errorText">加载失败</p>
            <button onclick="window.location.reload()" class="text-sm text-gray-600 hover:text-gray-900">
                重新加载
            </button>
        </div>
    </div>

    <script>
        // 从URL获取参数
        const urlParams = new URLSearchParams(window.location.search);
        const pendingId = urlParams.get('pending_id');
        const studentId = urlParams.get('student_id');

        let taskData = null;
        let studentData = null;

        // 页面加载时执行
        document.addEventListener('DOMContentLoaded', async () => {
            if (!pendingId) {
                showError('缺少必要参数');
                return;
            }

            await loadTaskData();

            if (studentId) {
                await loadStudentData();
            } else {
                showError('缺少学生信息');
            }
        });

        // 加载任务数据
        async function loadTaskData() {
            try {
                const response = await fetch('/api/pending');
                if (!response.ok) throw new Error('加载失败');

                const result = await response.json();
                const allPendingTasks = result.tasks || [];

                // 找到对应的任务
                const task = allPendingTasks.find(t => t.pending_id === pendingId);
                if (!task) {
                    showError('任务不存在或已过期');
                    return;
                }

                taskData = task.task_data;

                // 调试输出
                console.log('加载的任务数据:', taskData);
                console.log('任务类型:', taskData.type);
                console.log('是否有 raw_text:', 'raw_text' in taskData);

                renderTasks();

            } catch (error) {
                console.error('加载任务失败:', error);
                showError('加载任务失败: ' + error.message);
            }
        }

        // 加载学生数据
        async function loadStudentData() {
            try {
                const response = await fetch('/api/students');
                if (!response.ok) throw new Error('加载失败');

                const result = await response.json();
                const students = result.students || [];

                const student = students.find(s => s.student_id === studentId);
                if (student) {
                    studentData = student;
                    displayStudentInfo();
                    enableConfirmButton();
                } else {
                    showError('学生不存在');
                }

            } catch (error) {
                console.error('加载学生失败:', error);
            }
        }

        // 显示学生信息
        function displayStudentInfo() {
            const container = document.getElementById('studentInfo');
            const nameEl = document.getElementById('studentName');

            nameEl.textContent = studentData.name;
            container.classList.remove('hidden');
        }

        // 渲染任务列表
        function renderTasks() {
            const container = document.getElementById('taskList');

            // 处理三种不同的数据结构
            let tasks = [];
            let globalImages = [];
            let rawText = '';

            // 1. AI 多任务: {type: 'multiple', tasks: [...], images: [...]}
            if (taskData.type === 'multiple' && taskData.tasks) {
                tasks = taskData.tasks;
                globalImages = taskData.images || [];
                rawText = taskData.raw_text || '';
            }
            // 2. AI 单任务: {type: 'single', task: {task: {...}}, images: [...]}
            else if (taskData.type === 'single' && taskData.task) {
                // 修复：真正的任务数据在 taskData.task.task 里面
                const actualTask = taskData.task.task || taskData.task;
                tasks = [actualTask];
                globalImages = taskData.images || [];
                rawText = taskData.raw_text || '';
            }
            // 3. 纯图片任务或旧格式: {description: "...", subject: "...", images: [...]}
            else {
                tasks = [taskData];
                globalImages = taskData.images || [];
                rawText = taskData.raw_text || '';
            }

            if (tasks.length === 0) {
                container.innerHTML = '<div class="text-center py-10 text-gray-400">暂无任务</div>';
                return;
            }

            container.innerHTML = tasks.map((task, index) => {
                // 获取任务描述（AI 解析的标签）
                const aiDescription = task.description || task.details || '';
                const subject = task.subject || '未分类';

                // 合并全局图片和任务级图片
                const taskImages = task.images || [];
                const attachments = [...globalImages, ...taskImages];

                return `
                    <div class="task-card animate-slide-up" data-index="${index}" style="animation-delay: ${index * 0.1}s">
                        <!-- 任务头部：序号和标题 -->
                        <div class="task-header">
                            <div class="task-number">${index + 1}</div>
                            <div class="task-title">任务 ${index + 1}</div>
                        </div>

                        <!-- 科目标签 -->
                        <div class="flex items-center gap-2 mb-3">
                            <span class="text-xs px-2 py-1 bg-gray-100 text-gray-600 rounded">${subject}</span>
                        </div>

                        <!-- 原始文本（老师发的原文） -->
                        ${rawText ? `
                            <div class="mb-4">
                                <div class="editable-label">老师原文</div>
                                <div class="raw-text">${rawText}</div>
                            </div>
                        ` : ''}

                        <!-- 附件图片（小图） -->
                        ${attachments.length > 0 ? `
                            <div class="mb-4">
                                <div class="editable-label">图片附件 (${attachments.length})</div>
                                <div class="flex flex-wrap gap-2">
                                    ${attachments.map((img, imgIndex) => `
                                        <img src="${img}"
                                             alt="任务图片 ${imgIndex + 1}"
                                             class="attachment-img"
                                             onclick="window.open('${img}', '_blank')">
                                    `).join('')}
                                </div>
                            </div>
                        ` : ''}

                        <!-- AI 解析的任务描述（可编辑） -->
                        <div class="mb-3">
                            <div class="editable-label">AI 解析的任务描述</div>
                            <textarea
                                class="editable-field w-full"
                                rows="3"
                                data-field="description"
                                data-index="${index}"
                                placeholder="请输入或编辑任务描述">${aiDescription}</textarea>
                        </div>

                        <!-- 科目（可编辑） -->
                        <div class="mb-3">
                            <div class="editable-label">科目</div>
                            <input
                                type="text"
                                class="editable-field w-full"
                                data-field="subject"
                                data-index="${index}"
                                placeholder="请输入或选择科目"
                                value="${subject}">
                        </div>

                        <!-- 截止日期（可编辑） -->
                        <div class="mb-3">
                            <div class="editable-label">截止日期</div>
                            <input
                                type="date"
                                class="editable-field w-full"
                                data-field="deadline"
                                data-index="${index}"
                                ${(() => {
                                    try {
                                        if (task.deadline && task.deadline !== 'null' && task.deadline !== null) {
                                            const date = new Date(task.deadline);
                                            if (!isNaN(date.getTime())) {
                                                return `value="${date.toISOString().split('T')[0]}"`;
                                            }
                                        }
                                        return '';
                                    } catch (e) {
                                        return '';
                                    }
                                })()}>
                        </div>
                    </div>
                `;
            }).join('');

            // 隐藏加载状态
            document.getElementById('loadingState').classList.add('hidden');

            // 添加输入监听，实时更新 taskData
            addInputListeners();
        }

        // 添加输入监听
        function addInputListeners() {
            const editableFields = document.querySelectorAll('[data-field]');
            editableFields.forEach(field => {
                field.addEventListener('input', (e) => {
                    const index = parseInt(e.target.dataset.index);
                    const fieldName = e.target.dataset.field;
                    const value = e.target.value;

                    // 更新 taskData
                    if (taskData.type === 'multiple' && taskData.tasks) {
                        taskData.tasks[index][fieldName] = value;
                    } else if (taskData.type === 'single' && taskData.task) {
                        // 修复：更新真正的任务数据 taskData.task.task，而不是 wrapper
                        if (taskData.task.task) {
                            taskData.task.task[fieldName] = value;
                        } else {
                            taskData.task[fieldName] = value;
                        }
                    } else {
                        taskData[fieldName] = value;
                    }

                    console.log(`更新任务 ${index} 的 ${fieldName}: ${value}`);
                });
            });
        }

        // 启用确认按钮
        function enableConfirmButton() {
            const btn = document.getElementById('confirmBtn');
            btn.disabled = false;
        }

        // 确认任务
        async function confirmTasks() {
            if (!studentData || !taskData) {
                alert('数据不完整，请重新加载页面');
                return;
            }

            const btn = document.getElementById('confirmBtn');
            btn.disabled = true;
            btn.textContent = '确认中...';

            try {
                // 准备要发送的任务数据
                let tasksToSend = [];

                if (taskData.type === 'multiple' && taskData.tasks) {
                    tasksToSend = taskData.tasks;
                } else if (taskData.type === 'single' && taskData.task) {
                    // 修复：真正的任务数据在 taskData.task.task 里面
                    const actualTask = taskData.task.task || taskData.task;
                    tasksToSend = [actualTask];
                } else {
                    tasksToSend = [taskData];
                }

                const response = await fetch('/api/confirm', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        pending_id: pendingId,
                        student_id: studentId,
                        updated_tasks: tasksToSend
                    })
                });

                const result = await response.json();

                if (result.success) {
                    showSuccess();
                } else {
                    alert('确认失败：' + (result.error || '未知错误'));
                    btn.disabled = false;
                    btn.textContent = '确认创建任务';
                }

            } catch (error) {
                console.error('确认失败:', error);
                alert('确认失败：' + error.message);
                btn.disabled = false;
                btn.textContent = '确认创建任务';
            }
        }

        // 显示成功提示
        function showSuccess() {
            const modal = document.getElementById('successModal');
            const text = document.getElementById('successText');

            let taskCount = 1;
            if (taskData.type === 'multiple' && taskData.tasks) {
                taskCount = taskData.tasks.length;
            }

            text.textContent = `成功创建 ${taskCount} 个任务`;

            modal.classList.remove('hidden');
            modal.classList.add('flex');
        }

        // 跳转到任务页面
        function goToTasks() {
            // 隐藏弹窗
            const modal = document.getElementById('successModal');
            modal.classList.add('hidden');
            modal.classList.remove('flex');

            // 使用 location.replace 确保在同一个 HTTP 会话中跳转，cookie 不会被丢失
            window.location.replace('/my-tasks');
        }

        // 显示错误
        function showError(message) {
            document.getElementById('loadingState').classList.add('hidden');
            document.getElementById('errorState').classList.remove('hidden');
            document.getElementById('errorText').textContent = message;
        }
    </script>
</body>
</html>
