"""
微信网页授权配置
实现无需登录、自动识别身份的用户体验
"""

## 方案对比

### 方案1：微信公众号 + 网页授权（推荐 ⭐⭐⭐⭐⭐）

**用户体验：**
```
1. 家长转发消息给"AI家校助手"公众号
2. 公众号立即回复："✅ 已识别7条任务，<a href='链接'>点击查看确认</a>"
3. 家长点击链接 → 在微信内打开网页
4. 自动识别身份（无需登录）
5. 查看任务 → 选择学生 → 确认
6. 完成后自动返回公众号
```

**技术栈：**
- 微信公众号（服务号，需认证）
- 微信网页授权（OAuth2.0）
- 网页显示在微信内置浏览器中

**优点：**
- ✅ 体验流畅，不离开微信
- ✅ 自动获取用户OpenID（无需登录）
- ✅ 可以推送模板消息
- ✅ 支持自定义菜单
- ✅ 可以生成带参数二维码

**缺点：**
- ❌ 需要公众号认证（¥300/年）
- ❌ 需要备案域名

---

### 方案2：企业微信（推荐 ⭐⭐⭐⭐）

**用户体验：**
```
1. 家长转发消息给企业微信应用
2. 企业微信应用卡片展示："已识别7条任务"
3. 点击卡片 → 直接打开H5页面
4. 自动登录（企业微信自带身份）
5. 查看任务 → 确认
```

**技术栈：**
- 企业微信（免费）
- 企业微信应用
- 内置H5页面

**优点：**
- ✅ 完全免费
- ✅ 自带身份系统
- ✅ 可以集成到企业微信
- ✅ 支持更多企业功能

**缺点：**
- ❌ 需要企业注册
- ❌ 更适合机构使用

---

### 方案3：微信小程序（推荐 ⭐⭐⭐⭐）

**用户体验：**
```
1. 家长转发消息给小程序
2. 小程序立即显示解析结果
3. 在小程序内查看和确认
```

**技术栈：**
- 微信小程序
- 小程序云开发或自建后端

**优点：**
- ✅ 原生体验
- ✅ 无需安装
- ✅ 支持离线使用
- ✅ 可以添加到"我的小程序"

**缺点：**
- ❌ 开发成本稍高
- ❌ 需要小程序审核

---

### 方案4：测试号 + 内网嵌入（当前 MVP 方案 ⭐⭐⭐）

**用户体验：**
```
1. 家长转发消息给测试号
2. 测试号回复消息（带链接）
3. 点击链接 → 在微信内打开网页
4. 需要手动输入验证码或OpenID
```

**技术栈：**
- 微信测试号（免费）
- 内网穿透（ngrok/cpolar）
- 网页在微信浏览器中打开

**优点：**
- ✅ 免费，无需认证
- ✅ 快速验证MVP
- ✅ 在微信内打开

**缺点：**
- ❌ 需要手动身份验证
- ❌ 内网穿透不稳定
- ❌ 只能个人测试

---

## 🎯 MVP 推荐方案

### 阶段1：测试号 + 网页授权（当前实现）

**实现步骤：**

1. **在测试号配置回调域名**
   - URL: https://your-domain.com
   - Token: your-token

2. **消息回复包含链接**
   ```python
   # 在 app.py 中修改
   def build_confirm_message(result, pending_id):
       base_url = "https://your-domain.com"
       confirm_url = f"{base_url}/confirm?pending_id={pending_id}"

       return f"""✅ 已识别 {result['total_tasks']} 条任务

点击查看详情：{confirm_url}

该链接在微信中打开，可直接确认任务"""
   ```

3. **网页自动识别OpenID**
   ```python
   @app.route('/confirm')
   def confirm_page():
       # 从微信授权回调获取 code
       code = request.args.get('code')

       # 换取 openid
       openid = get_wechat_openid(code)

       # 查询待确认任务
       pending_id = request.args.get('pending_id')

       # 渲染页面（自动填充身份）
       return render_template('confirm.html',
                             openid=openid,
                             pending_id=pending_id)
   ```

4. **页面自适应**
   - 检测是否在微信浏览器中打开
   - 移动端优化
   - 支持触摸操作

---

### 阶段2：升级到企业微信（长期方案）

**推荐理由：**
- 免费且功能强大
- 自带身份系统
- 适合培训机构/学校使用
- 可以邀请家长加入

**升级路径：**
```
当前：测试号 + 手动验证
  ↓
3个月后：企业微信 + 自动登录
  ↓
用户增长后：服务号 + 模板消息推送
```

---

## 💻 立即实现：微信内网页优化

让我创建一个微信友好的确认页面：
