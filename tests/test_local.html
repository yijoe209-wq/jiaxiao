<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æœ¬åœ°æµ‹è¯•é¡µé¢ - å®¶æ ¡ä»»åŠ¡åŠ©æ‰‹</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
            background: #f5f5f5;
            padding: 20px;
        }
        .container {
            max-width: 1200px;
            margin: 0 auto;
        }
        .section {
            background: white;
            padding: 20px;
            margin-bottom: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        h1 {
            color: #333;
            margin-bottom: 20px;
        }
        h2 {
            color: #666;
            margin-bottom: 15px;
            font-size: 18px;
        }
        .button-group {
            display: flex;
            gap: 10px;
            margin-bottom: 15px;
            flex-wrap: wrap;
        }
        button {
            padding: 10px 20px;
            background: #007AFF;
            color: white;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
        }
        button:hover {
            background: #0051D5;
        }
        button:disabled {
            background: #ccc;
            cursor: not-allowed;
        }
        input, select {
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 6px;
            font-size: 14px;
            margin-right: 10px;
            margin-bottom: 10px;
        }
        input[type="text"] {
            width: 200px;
        }
        textarea {
            width: 100%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 6px;
            font-size: 14px;
            min-height: 80px;
            margin-bottom: 10px;
        }
        .result {
            background: #f9f9f9;
            padding: 15px;
            border-radius: 6px;
            margin-top: 10px;
            font-size: 14px;
            white-space: pre-wrap;
            word-break: break-all;
        }
        .success {
            color: #4CAF50;
        }
        .error {
            color: #f44336;
        }
        .info {
            color: #2196F3;
        }
        .student-list, .task-list {
            margin-top: 10px;
        }
        .student-item, .task-item {
            background: #f0f0f0;
            padding: 10px;
            margin-bottom: 5px;
            border-radius: 4px;
            font-size: 14px;
        }
        .status {
            display: inline-block;
            padding: 2px 8px;
            border-radius: 3px;
            font-size: 12px;
            margin-left: 10px;
        }
        .status.pending {
            background: #FF9800;
            color: white;
        }
        .status.completed {
            background: #4CAF50;
            color: white;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸ§ª æœ¬åœ°æµ‹è¯•é¡µé¢ - å®¶æ ¡ä»»åŠ¡åŠ©æ‰‹</h1>

        <div class="section">
            <h2>1ï¸âƒ£ ç”¨æˆ·æ³¨å†Œ</h2>
            <input type="text" id="regName" placeholder="å®¶é•¿å§“å" value="æµ‹è¯•ç”¨æˆ·">
            <input type="text" id="regEmail" placeholder="é‚®ç®±" value="test@example.com">
            <input type="password" id="regPassword" placeholder="å¯†ç ï¼ˆè‡³å°‘6ä½ï¼‰" value="test123">
            <button onclick="testRegister()">æ³¨å†Œ</button>
            <div id="regResult" class="result"></div>
        </div>

        <div class="section">
            <h2>2ï¸âƒ£ æ·»åŠ å­¦ç”Ÿ</h2>
            <input type="text" id="studentName" placeholder="å­¦ç”Ÿå§“å" value="å¼ ä¸‰">
            <select id="studentGrade">
                <option value="ä¸€å¹´çº§">ä¸€å¹´çº§</option>
                <option value="äºŒå¹´çº§">äºŒå¹´çº§</option>
                <option value="ä¸‰å¹´çº§">ä¸‰å¹´çº§</option>
                <option value="å››å¹´çº§">å››å¹´çº§</option>
                <option value="äº”å¹´çº§">äº”å¹´çº§</option>
                <option value="å…­å¹´çº§">å…­å¹´çº§</option>
            </select>
            <button onclick="testAddStudent()">æ·»åŠ å­¦ç”Ÿ</button>
            <div id="studentResult" class="result"></div>
            <div id="studentList" class="student-list"></div>
        </div>

        <div class="section">
            <h2>3ï¸âƒ£ åˆ›å»ºä»»åŠ¡ï¼ˆAIè§£æï¼‰</h2>
            <textarea id="taskMessage" placeholder="è¾“å…¥ä½œä¸šå†…å®¹ï¼Œä¾‹å¦‚ï¼šæ•°å­¦ä½œä¸šï¼šç»ƒä¹ å†Œç¬¬10-12é¡µï¼Œæ˜å¤©äº¤">æ•°å­¦ä½œä¸šï¼šç»ƒä¹ å†Œç¬¬10-12é¡µï¼Œæ˜å¤©äº¤</textarea>
            <select id="taskStudent">
                <option value="">é€‰æ‹©å­¦ç”Ÿ</option>
            </select>
            <button onclick="testCreateTask()">AIè§£æå¹¶åˆ›å»ºä»»åŠ¡</button>
            <div id="taskResult" class="result"></div>
        </div>

        <div class="section">
            <h2>4ï¸âƒ£ æŸ¥çœ‹ä»»åŠ¡åˆ—è¡¨</h2>
            <button onclick="testGetTasks()">åˆ·æ–°ä»»åŠ¡åˆ—è¡¨</button>
            <div id="taskList" class="task-list"></div>
        </div>

        <div class="section">
            <h2>5ï¸âƒ£ å¿«é€Ÿæ“ä½œ</h2>
            <div class="button-group">
                <button onclick="checkLogin()">æ£€æŸ¥ç™»å½•çŠ¶æ€</button>
                <button onclick="getStudents()">åˆ·æ–°å­¦ç”Ÿåˆ—è¡¨</button>
                <button onclick="clearResults()">æ¸…ç©ºç»“æœæ˜¾ç¤º</button>
            </div>
            <div id="quickResult" class="result"></div>
        </div>
    </div>

    <script>
        const API_BASE = 'http://localhost:5001';
        let cookies = '';

        // ä¿å­˜cookies
        function saveCookies(responseHeaders) {
            const setCookieHeaders = responseHeaders.filter(h => h.includes('Set-Cookie'));
            cookies = setCookieHeaders.map(h => {
                const match = h.match(/([^=]+)=([^;]+)/);
                return match ? `${match[1]}=${match[2]}` : '';
            }).filter(c => c).join('; ');
        }

        // è·å–fetch headers
        function getHeaders() {
            const headers = {
                'Content-Type': 'application/json'
            };
            if (cookies) {
                headers['Cookie'] = cookies;
            }
            return headers;
        }

        // æµ‹è¯•æ³¨å†Œ
        async function testRegister() {
            const name = document.getElementById('regName').value;
            const email = document.getElementById('regEmail').value;
            const password = document.getElementById('regPassword').value;

            const result = document.getElementById('regResult');
            result.className = 'result info';
            result.textContent = 'æ³¨å†Œä¸­...';

            try {
                const response = await fetch(`${API_BASE}/api/register`, {
                    method: 'POST',
                    headers: getHeaders(),
                    body: JSON.stringify({
                        parent_name: name,
                        email: email,
                        password: password
                    })
                });

                // ä¿å­˜cookies
                saveCookies([...response.headers]);

                const data = await response.json();

                if (data.success) {
                    result.className = 'result success';
                    result.textContent = `âœ… æ³¨å†ŒæˆåŠŸï¼\nFamily ID: ${data.family_id}\nå®¶é•¿å§“å: ${data.parent_name}`;
                } else {
                    result.className = 'result error';
                    result.textContent = `âŒ æ³¨å†Œå¤±è´¥: ${data.error}`;
                }
            } catch (error) {
                result.className = 'result error';
                result.textContent = `âŒ æ³¨å†Œå¤±è´¥: ${error.message}`;
            }
        }

        // æµ‹è¯•æ·»åŠ å­¦ç”Ÿ
        async function testAddStudent() {
            const name = document.getElementById('studentName').value;
            const grade = document.getElementById('studentGrade').value;

            const result = document.getElementById('studentResult');
            result.className = 'result info';
            result.textContent = 'æ·»åŠ ä¸­...';

            try {
                const response = await fetch(`${API_BASE}/api/students`, {
                    method: 'POST',
                    headers: getHeaders(),
                    body: JSON.stringify({
                        name: name,
                        grade: grade
                    })
                });

                const data = await response.json();

                if (data.success) {
                    result.className = 'result success';
                    result.textContent = `âœ… æ·»åŠ æˆåŠŸï¼\nStudent ID: ${data.student_id}`;
                    getStudents(); // åˆ·æ–°å­¦ç”Ÿåˆ—è¡¨
                } else {
                    result.className = 'result error';
                    result.textContent = `âŒ æ·»åŠ å¤±è´¥: ${data.error}`;
                }
            } catch (error) {
                result.className = 'result error';
                result.textContent = `âŒ æ·»åŠ å¤±è´¥: ${error.message}`;
            }
        }

        // æµ‹è¯•åˆ›å»ºä»»åŠ¡
        async function testCreateTask() {
            const message = document.getElementById('taskMessage').value;
            const studentId = document.getElementById('taskStudent').value;

            if (!studentId) {
                alert('è¯·å…ˆé€‰æ‹©å­¦ç”Ÿ');
                return;
            }

            const result = document.getElementById('taskResult');
            result.className = 'result info';
            result.textContent = 'AI è§£æä¸­...';

            try {
                // ç¬¬ä¸€æ­¥ï¼šAIè§£æ
                const simulateResponse = await fetch(`${API_BASE}/api/simulate`, {
                    method: 'POST',
                    headers: getHeaders(),
                    body: JSON.stringify({ message: message })
                });

                const simulateData = await simulateResponse.json();

                if (!simulateData.success) {
                    throw new Error(simulateData.error || 'AIè§£æå¤±è´¥');
                }

                result.className = 'result info';
                result.textContent = `âœ… AIè§£ææˆåŠŸ\nPending ID: ${simulateData.pending_id}\næ­£åœ¨åˆ›å»ºä»»åŠ¡...`;

                // ç¬¬äºŒæ­¥ï¼šç¡®è®¤åˆ›å»º
                const confirmResponse = await fetch(`${API_BASE}/api/confirm`, {
                    method: 'POST',
                    headers: getHeaders(),
                    body: JSON.stringify({
                        pending_id: simulateData.pending_id,
                        student_id: studentId
                    })
                });

                const confirmData = await confirmResponse.json();

                if (confirmData.success) {
                    result.className = 'result success';
                    result.textContent = `âœ… ä»»åŠ¡åˆ›å»ºæˆåŠŸï¼\nTask ID: ${confirmData.task_id}\n\nå¯ä»¥å»æŸ¥çœ‹ä»»åŠ¡åˆ—è¡¨äº†`;
                    testGetTasks(); // åˆ·æ–°ä»»åŠ¡åˆ—è¡¨
                } else {
                    result.className = 'result error';
                    result.textContent = `âŒ åˆ›å»ºå¤±è´¥: ${confirmData.error}`;
                }
            } catch (error) {
                result.className = 'result error';
                result.textContent = `âŒ åˆ›å»ºå¤±è´¥: ${error.message}`;
            }
        }

        // è·å–å­¦ç”Ÿåˆ—è¡¨
        async function getStudents() {
            try {
                const response = await fetch(`${API_BASE}/api/students`, {
                    headers: getHeaders()
                });

                const data = await response.json();

                if (data.success) {
                    const list = document.getElementById('studentList');
                    const select = document.getElementById('taskStudent');

                    // æ˜¾ç¤ºå­¦ç”Ÿåˆ—è¡¨
                    list.innerHTML = data.students.map(s =>
                        `<div class="student-item">
                            ğŸ“š ${s.name}ï¼ˆ${s.grade}ï¼‰
                            <small>ID: ${s.student_id}</small>
                        </div>`
                    ).join('') || '<div class="info">è¿˜æ²¡æœ‰å­¦ç”Ÿ</div>';

                    // æ›´æ–°ä¸‹æ‹‰æ¡†
                    select.innerHTML = '<option value="">é€‰æ‹©å­¦ç”Ÿ</option>' +
                        data.students.map(s =>
                            `<option value="${s.student_id}">${s.name}ï¼ˆ${s.grade}ï¼‰</option>`
                        ).join('');
                }
            } catch (error) {
                console.error('è·å–å­¦ç”Ÿåˆ—è¡¨å¤±è´¥:', error);
            }
        }

        // è·å–ä»»åŠ¡åˆ—è¡¨
        async function testGetTasks() {
            const result = document.getElementById('taskList');
            result.className = 'result info';
            result.textContent = 'åŠ è½½ä¸­...';

            try {
                const response = await fetch(`${API_BASE}/api/students`, {
                    headers: getHeaders()
                });

                const studentsData = await response.json();

                if (!studentsData.success || !studentsData.students.length) {
                    result.className = 'result info';
                    result.textContent = 'è¿˜æ²¡æœ‰å­¦ç”Ÿæˆ–ä»»åŠ¡';
                    return;
                }

                // è·å–æ¯ä¸ªå­¦ç”Ÿçš„ä»»åŠ¡
                let allTasks = [];
                for (const student of studentsData.students) {
                    const taskResponse = await fetch(`${API_BASE}/api/tasks/${student.student_id}`, {
                        headers: getHeaders()
                    });

                    const taskData = await taskResponse.json();
                    if (taskData.success) {
                        allTasks = allTasks.concat(taskData.tasks.map(t => ({
                            ...t,
                            student_name: student.name,
                            student_grade: student.grade
                        })));
                    }
                }

                // æ˜¾ç¤ºä»»åŠ¡
                result.innerHTML = allTasks.length ? allTasks.map(t => `
                    <div class="task-item">
                        <strong>${t.subject || 'æœªåˆ†ç±»'}</strong>: ${t.description}
                        <br><small>å­¦ç”Ÿ: ${t.student_name} | æˆªæ­¢: ${t.deadline || 'æ— '}</small>
                        <span class="status ${t.is_completed ? 'completed' : 'pending'}">
                            ${t.is_completed ? 'å·²å®Œæˆ' : 'å¾…å®Œæˆ'}
                        </span>
                        ${!t.is_completed ? `<button onclick="completeTask('${t.task_id}')" style="margin-left:10px;padding:5px 10px;font-size:12px;">æ ‡è®°å®Œæˆ</button>` : ''}
                    </div>
                `).join('') : '<div class="info">è¿˜æ²¡æœ‰ä»»åŠ¡</div>';

            } catch (error) {
                result.className = 'result error';
                result.textContent = `åŠ è½½å¤±è´¥: ${error.message}`;
            }
        }

        // æ ‡è®°ä»»åŠ¡å®Œæˆ
        async function completeTask(taskId) {
            try {
                const response = await fetch(`${API_BASE}/api/tasks/${taskId}/complete`, {
                    method: 'POST',
                    headers: getHeaders()
                });

                const data = await response.json();
                if (data.success) {
                    testGetTasks(); // åˆ·æ–°åˆ—è¡¨
                } else {
                    alert('æ“ä½œå¤±è´¥: ' + data.error);
                }
            } catch (error) {
                alert('æ“ä½œå¤±è´¥: ' + error.message);
            }
        }

        // æ£€æŸ¥ç™»å½•çŠ¶æ€
        async function checkLogin() {
            const result = document.getElementById('quickResult');
            result.className = 'result info';
            result.textContent = 'æ£€æŸ¥ä¸­...';

            try {
                const response = await fetch(`${API_BASE}/api/auth/check`, {
                    headers: getHeaders()
                });

                const data = await response.json();

                if (data.loggedIn) {
                    result.className = 'result success';
                    result.textContent = `âœ… å·²ç™»å½•\nEmail: ${data.user.email}\nå®¶é•¿: ${data.user.parent_name}`;
                    getStudents(); // åŒæ—¶åŠ è½½å­¦ç”Ÿåˆ—è¡¨
                } else {
                    result.className = 'result error';
                    result.textContent = 'âŒ æœªç™»å½•ï¼Œè¯·å…ˆæ³¨å†Œ';
                }
            } catch (error) {
                result.className = 'result error';
                result.textContent = `æ£€æŸ¥å¤±è´¥: ${error.message}`;
            }
        }

        // æ¸…ç©ºç»“æœæ˜¾ç¤º
        function clearResults() {
            document.getElementById('regResult').textContent = '';
            document.getElementById('studentResult').textContent = '';
            document.getElementById('taskResult').textContent = '';
            document.getElementById('quickResult').textContent = '';
        }

        // é¡µé¢åŠ è½½æ—¶æ£€æŸ¥ç™»å½•çŠ¶æ€
        window.addEventListener('DOMContentLoaded', () => {
            checkLogin();
        });
    </script>
</body>
</html>
