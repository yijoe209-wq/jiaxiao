# 🎓 家校信息智能管家 - 完整使用指南

## 📑 目录

1. [快速开始](#快速开始)
2. [核心功能](#核心功能)
3. [使用流程](#使用流程)
4. [页面功能说明](#页面功能说明)
5. [API 接口](#api-接口)
6. [常见问题](#常见问题)
7. [开发调试](#开发调试)

---

## 🚀 快速开始

### 第一步：安装和配置

```bash
# 1. 安装依赖
pip install -r requirements.txt

# 2. 配置环境变量
cp .env.example .env
# 编辑 .env 文件，至少配置：
# LLM_API_KEY=sk-your-deepseek-api-key
# WECHAT_TOKEN=your-random-token

# 3. 初始化数据库（包含测试数据）
python init_db.py
# 选择选项 4：创建表 + 测试数据

# 4. 启动服务
python app.py
```

服务将在 `http://localhost:5001` 启动。

### 第二步：验证安装

访问以下页面验证服务是否正常：

- **健康检查**: http://localhost:5001/health
- **系统监控**: http://localhost:5001/
- **模拟测试**: http://localhost:5001/simulate

---

## 🎯 核心功能

### 1. 智能任务解析

基于 DeepSeek AI 模型，自动从老师消息中提取任务信息：

- ✅ 支持多条任务同时识别
- ✅ 自动分类任务类型（阅读、背诵、书写、练习、听写等）
- ✅ 提取任务详情和要求
- ✅ 智能降级策略（AI 失败时使用关键词匹配）

### 2. 任务管理

- 📋 待确认任务：AI 解析后等待用户确认的任务
- ✅ 已确认任务：用户确认后正式入库的任务
- 👥 多学生支持：一个家庭管理多个学生的任务
- 🔍 任务筛选：按学生、状态查看任务

### 3. 用户友好界面

- 📱 移动端优化设计
- 🎨 现代化 UI/UX
- ⚡ 即时响应反馈
- 🔔 操作成功提示

---

## 📖 使用流程

### 方式一：模拟测试（推荐用于体验和测试）

**适用场景**：
- 快速体验系统功能
- 测试 AI 解析效果
- 不需要配置微信公众号

**操作步骤**：

```
1. 打开浏览器访问：http://localhost:5001/simulate

2. 准备老师消息
   - 从微信群复制老师的消息
   - 或点击页面上的"使用此示例"按钮

3. 粘贴消息到输入框

4. 点击"📤 模拟转发给AI助手"按钮

5. 查看解析结果
   - 系统显示识别到多少条任务
   - 显示任务预览

6. 点击"👉 点此确认任务"链接
   - 跳转到确认页面
   - 查看所有任务的详细信息

7. 选择学生并确认
   - 选择要分配给哪个学生（小明/小红）
   - 点击"✓ 确认并创建任务"按钮

8. 查看任务列表
   - 自动跳转到任务管理页面
   - 查看所有已创建的任务
```

**示例老师消息**：
```
语文任务：
1.阅读打卡：
朗读《语文园地八》这课，会认字和会写字口头拼读并组词。

2.背诵课本1--8单元要求背诵的所有内容。
背诵课本105页的成语和日积月累，录音上传小管家。

3.认真修改作业本里面的错误。

（... 更多任务）
```

### 方式二：微信公众号（生产环境）

**适用场景**：
- 真实使用环境
- 家长在微信中直接操作
- 需要配置微信公众号

**操作步骤**：

```
1. 配置微信公众号（需要公网域名）
   - 注册微信测试号或服务号
   - 配置服务器地址
   - 设置 Token

2. 家长在微信中操作
   - 长按老师消息 → 转发给"AI家校助手"
   - 公众号自动回复解析结果
   - 点击回复中的链接
   - 在微信内打开确认页面
   - 选择学生并确认

3. 查看和管理任务
   - 在公众号菜单中查看任务
   - 或访问任务管理页面
```

---

## 🖥️ 页面功能说明

### 1. 模拟测试页面 (/simulate)

**功能**：模拟微信转发消息，测试 AI 解析功能

**使用方法**：
1. 在文本框中粘贴老师消息
2. 点击"模拟转发"按钮
3. 查看解析结果
4. 点击确认链接进入确认页面

**特点**：
- ✅ 无需配置微信即可测试
- ✅ 提供示例消息
- ✅ 显示详细解析结果
- ✅ 一键跳转到确认页面

### 2. 确认页面 (/confirm)

**功能**：查看 AI 解析的任务详情，选择学生并确认

**页面元素**：
- **任务摘要**：显示识别到多少条任务
- **任务列表**：每个任务的详细信息
  - 任务序号
  - 任务类型（阅读/背诵/书写等）
  - 任务标题
  - 任务详情
- **学生选择**：单选按钮选择学生
- **确认按钮**：确认并创建任务

**操作流程**：
```
1. 查看任务列表
   ↓
2. 确认任务识别正确
   ↓
3. 选择学生（单选）
   ↓
4. 点击"确认并创建任务"
   ↓
5. 等待 3 秒，自动跳转到任务列表
```

**任务类型标签颜色**：
- 🔵 阅读 - 蓝色
- 🟠 背诵 - 橙色
- 🟣 书写 - 紫色
- 🟢 练习 - 绿色
- 🔴 听写 - 红色
- ⚪ 其他 - 灰色

### 3. 任务管理页面 (/tasks)

**功能**：查看和管理所有任务

**页面分区**：
- **待确认任务**：需要确认的任务
- **已确认任务**：已入库的任务

**任务卡片显示**：
- 学生姓名
- 任务描述
- 任务类型标签
- 创建时间
- 操作按钮（完成/删除）

**筛选功能**：
- 按学生筛选
- 按状态筛选（全部/待确认/已完成）
- 按任务类型筛选

### 4. 系统监控页面 (/)

**功能**：查看系统运行状态和指标

**显示内容**：
- 系统健康状态
- 消息处理统计
- LLM 调用次数
- 平均响应时间
- 错误率统计

---

## 🔌 API 接口

### 1. 模拟转发接口

**接口**: `/api/simulate`

**方法**: POST

**参数**:
```json
{
  "message": "老师消息内容"
}
```

**返回**:
```json
{
  "success": true,
  "total_tasks": 7,
  "pending_id": "uuid",
  "message": "消息解析成功，请点击链接确认"
}
```

**使用示例**:
```bash
curl -X POST http://localhost:5001/api/simulate \
  -H "Content-Type: application/json" \
  -d '{"message": "明天背诵《山行》"}'
```

### 2. 确认任务接口

**接口**: `/api/confirm`

**方法**: POST

**参数**:
```json
{
  "pending_id": "任务ID",
  "student_id": "学生ID"
}
```

**返回**:
```json
{
  "success": true,
  "task_count": 7,
  "message": "任务已成功创建"
}
```

### 3. 获取任务列表接口

**接口**: `/api/tasks/<student_id>`

**方法**: GET

**返回**:
```json
{
  "success": true,
  "tasks": [
    {
      "task_id": "uuid",
      "description": "背诵《山行》",
      "task_type": "背诵",
      "status": "pending",
      "deadline": "2025-01-11"
    }
  ]
}
```

### 4. 标记任务完成接口

**接口**: `/api/tasks/<task_id>/complete`

**方法**: POST

**返回**:
```json
{
  "success": true,
  "message": "任务已完成"
}
```

### 5. 获取待确认任务接口

**接口**: `/api/pending`

**方法**: GET

**返回**:
```json
{
  "success": true,
  "tasks": [
    {
      "pending_id": "uuid",
      "wechat_id": "openid",
      "task_data": {...},
      "created_at": "2025-01-10T10:00:00",
      "expires_at": "2025-01-10T10:05:00"
    }
  ]
}
```

### 6. 健康检查接口

**接口**: `/health`

**方法**: GET

**返回**:
```json
{
  "status": "ok",
  "timestamp": "2025-01-10T10:00:00",
  "checks": {
    "database": "ok",
    "llm_api": "configured"
  }
}
```

### 7. 系统指标接口

**接口**: `/metrics`

**方法**: GET

**返回**:
```json
{
  "total_requests": 100,
  "llm_calls": 50,
  "fallback_calls": 5,
  "avg_response_time": 1.5
}
```

---

## ❓ 常见问题

### Q1: 如何快速测试系统功能？

**A**: 访问 http://localhost:5001/simulate

1. 点击"使用此示例"按钮
2. 点击"模拟转发"
3. 点击确认链接
4. 选择学生并确认

全程无需配置微信，适合快速体验。

### Q2: AI 解析失败怎么办？

**A**: 系统有智能降级策略

1. 优先使用 DeepSeek AI 解析
2. 如果失败，自动降级到关键词匹配
3. 查看日志了解失败原因：
   ```bash
   tail -f logs/app.log
   ```

### Q3: 支持哪些类型的任务？

**A**: 系统自动识别以下类型：

- 📖 阅读：朗读、阅读打卡等
- 🗣️ 背诵：背诵、记忆等
- ✍️ 书写：抄写、写字等
- 📝 练习：习题、练习册等
- 🎧 听写：听写测试等
- 📋 其他：未分类任务

### Q4: 如何添加新的学生？

**A**: 修改测试数据或使用 API

当前版本中，学生信息在 `init_db.py` 中定义：

```python
# 测试数据
students = [
    Student(name='小明', grade='三年级'),
    Student(name='小红', grade='一年级')
]
```

运行 `python init_db.py` 重新初始化即可。

### Q5: 任务确认后如何修改？

**A**: 当前版本支持标记完成

1. 访问任务管理页面
2. 找到对应任务
3. 点击"完成"按钮
4. 任务状态更新为"已完成"

如需修改任务内容，需要删除后重新创建。

### Q6: 如何查看系统日志？

**A**: 日志文件在 `logs/` 目录

```bash
# 实时查看所有日志
tail -f logs/app.log

# 查看错误日志
grep ERROR logs/app.log

# 查看 LLM 解析日志
grep "llm" logs/app.log
```

### Q7: 端口 5000 被占用怎么办？

**A**: 系统默认使用 5001 端口

修改 `.env` 文件中的 PORT 配置：

```bash
PORT=5001  # 修改为其他端口
```

### Q8: 如何配置真实的微信公众号？

**A**: 参考 QUICKSTART.md 的"接入微信"章节

需要：
1. 注册微信测试号或服务号
2. 配置服务器地址（需要公网域名）
3. 设置 Token
4. 验证配置

测试阶段推荐使用模拟测试页面。

### Q9: 测试数据中的学生ID是什么？

**A**: 两个测试学生的 ID

- 小明: `bde646c6-6bef-4f8b-88b0-705925f201f8`
- 小红: `a8d6658c-0596-4725-bad0-87b9d77d40e8`

可以在数据库中查询：

```python
from models import db, Student
session = db.get_session()
students = session.query(Student).all()
for s in students:
    print(f"{s.name}: {s.student_id}")
```

### Q10: 如何重置数据库？

**A**: 删除数据库文件并重新初始化

```bash
# 删除数据库
rm jiaxiao.db

# 重新初始化
python init_db.py
```

---

## 🛠️ 开发调试

### 启用调试模式

修改 `.env` 文件：

```bash
DEBUG=True
```

### 查看详细日志

修改 `config.py` 中的日志级别：

```python
LOG_LEVEL = 'DEBUG'  # INFO, WARNING, ERROR
```

### 测试 LLM 解析

```bash
python test_llm.py
```

### 测试单个功能

```python
# 测试消息解析
python -c "from llm_parser import parse_message; print(parse_message('明天背诵《山行》', []))"

# 测试数据库连接
python -c "from models import db, init_db; init_db(); print('Database OK')"
```

### 性能优化

1. **减少 LLM 调用**：调整 `config.py` 中的缓存设置
2. **数据库优化**：添加索引（已在 `models.py` 中配置）
3. **并发处理**：使用 Celery（生产环境推荐）

---

## 📚 相关文档

- [快速开始指南](QUICKSTART.md) - 安装和配置
- [产品设计文档](Product.md) - 产品功能和技术方案
- [用户体验设计](USER_EXPERIENCE.md) - 交互流程和界面设计
- [MVP 范围](MVP_SCOPE.md) - 功能优先级
- [安全指南](SECURITY_GUIDE.md) - 数据安全最佳实践

---

## 🎉 下一步

1. **体验系统**: 访问 http://localhost:5001/simulate
2. **查看效果**: 使用示例消息测试 AI 解析
3. **确认任务**: 选择学生并创建任务
4. **管理任务**: 在任务页面查看和操作
5. **配置微信**: 参考 QUICKSTART.md 配置真实微信（可选）

---

**需要帮助？**

- 查看日志: `logs/app.log`
- 健康检查: http://localhost:5001/health
- 系统指标: http://localhost:5001/metrics
- 提交问题: GitHub Issues

祝你使用愉快！🎊
