# 🚀 微信测试号配置指南 - 30分钟完成

## 📋 配置清单

在开始之前，请准备：
- [ ] 电脑浏览器
- [ ] 手机微信（用于扫码）
- [ ] 当前项目目录：`/Volumes/data/vibe-coding-projects/jiaxiao`
- [ ] Flask 应用正在运行（端口 5001）

---

## 🎯 第一步：申请微信测试号（5分钟）

### 1. 访问测试号申请页面

**在电脑浏览器中打开：**
```
https://mp.weixin.qq.com/debug/cgi-bin/sandbox?t=sandbox/login
```

### 2. 扫码登录

- 用手机微信扫描页面上的二维码
- 确认授权登录

### 3. 获取配置信息

登录后会看到测试号管理页面，需要记录以下信息：

```
✅ appID: wx???????????????? （16位字符）
✅ appsecret: ??????????????????????? （32位字符）
```

**重要：** 这两个参数等下需要配置到 `.env` 文件中

### 4. 查看测试号信息

页面会显示：
- **测试号信息：** appID、appsecret
- **测试号二维码：** 用于关注测试号
- **接口配置信息：** 需要填写服务器地址
- **用户列表：** 关注了测试号的用户

---

## ⚙️ 第二步：配置 .env 文件（2分钟）

### 1. 打开 .env 文件

```bash
cd /Volumes/data/vibe-coding-projects/jiaxiao
nano .env
# 或使用任何文本编辑器打开
```

### 2. 添加微信配置

在 `.env` 文件中找到微信配置部分，填写刚才获取的信息：

```bash
# 微信配置
WECHAT_TOKEN=jiaxiao123                    # 自定义Token（自己设定）
WECHAT_APP_ID=wx从测试号页面复制          # 从测试号页面复制
WECHAT_APP_SECRET=从测试号页面复制        # 从测试号页面复制
WECHAT_ENCODING_AES_KEY=                  # 留空即可
```

**关键说明：**
- `WECHAT_TOKEN`：自己设定，比如 `jiaxiao123`，等下配置服务器时要一致
- `WECHAT_APP_ID`：从测试号页面复制
- `WECHAT_APP_SECRET`：从测试号页面复制

### 3. 保存文件

保存并关闭 `.env` 文件

---

## 🌐 第三步：配置服务器地址（5分钟）

### 选项 A: 使用局域网地址（仅自己测试）⭐推荐

**服务器 URL：**
```
http://192.168.0.113:5001/wechat
```

**优点：**
- ✅ 不需要外网
- ✅ 配置简单
- ✅ 速度快

**限制：**
- ⚠️ 只能在同一 Wi-Fi 下测试
- ⚠️ 只有自己能测试

---

### 选项 B: 使用 Cloudflare Tunnel（可分享给他人）

**当前 Cloudflare Tunnel 地址：**
```
https://achievement-senior-any-manchester.trycloudflare.com
```

**服务器 URL：**
```
https://achievement-senior-any-manchester.trycloudflare.com/wechat
```

**优点：**
- ✅ 可以分享给其他人
- ✅ HTTPS 加密

**限制：**
- ⚠️ Cloudflare Tunnel 地址可能变化
- ⚠️ 需要保持 tunnel 运行

---

### 配置步骤（两种选项通用）

**在测试号页面填写接口配置信息：**

1. **URL：**
   ```
   http://192.168.0.113:5001/wechat
   或
   https://achievement-senior-any-manchester.trycloudflare.com/wechat
   ```

2. **Token：**
   ```
   jiaxiao123
   ```
   （必须与 .env 中的 WECHAT_TOKEN 一致）

3. **EncodingAESKey：**
   - 点击"随机生成"按钮
   - 或留空

4. **消息加解密方式：**
   - 选择 **明文模式**（推荐）

5. **点击"提交"按钮**

---

## ✅ 第四步：验证配置（3分钟）

### 提交后会发生什么

**如果配置成功：**
```
✅ 提交成功
URL 有效的
Token 验证成功
```

**如果配置失败：**
```
❌ Token验证失败
或
❌ 系统繁忙
```

### 排查失败原因

**1. Token 验证失败**
- 检查 `.env` 中的 `WECHAT_TOKEN` 是否与页面填写的一致
- 检查 Flask 应用是否正在运行
- 重启 Flask 应用：
  ```bash
  cd /Volumes/data/vibe-coding-projects/jiaxiao
  python app.py
  ```

**2. URL 无法访问**
- 检查 Flask 应用是否运行：`http://localhost:5001/health`
- 检查端口是否正确：`5001`
- 如果使用 Cloudflare Tunnel，检查 tunnel 是否运行

**3. 系统繁忙**
- 等待几分钟后重试
- 检查网络连接

---

## 📱 第五步：关注测试号（2分钟）

### 在测试号页面

1. 找到 **"测试号二维码"**
2. 用手机微信扫描二维码
3. 关注测试号

### 查看你的 OpenID

关注后，在测试号页面的 **"用户列表"** 中可以看到你的信息：

```
OpenID: oxxxxxxxxxxxxxxxxxxxxxxx （28位字符）
昵称: 你的微信昵称
```

**重要：** 记下这个 OpenID，等下测试时会用到

---

## 🧪 第六步：测试消息接收（10分钟）

### 测试 1: 发送文本消息

**在手机上，给测试号发送消息：**

```
语文作业：
1. 背诵《山行》古诗
2. 完成练习册第5页
```

**预期结果（2秒内收到回复）：**
```
✅ 收到！正在智能解析中，请稍后...
```

**然后立即收到：**
```
✅ 已识别任务

📊 共 2 条任务
1. 背诵《山行》古诗
2. 完成练习册第5页

━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━

👉 点此确认任务

在微信中打开，可直接分配给学生
```

---

### 测试 2: 发送图片消息

**给测试号发送一张图片**

**预期结果：**
```
📷 图片已收到（1/1）

继续发送文字或其他图片，完成后请发送文字消息触发解析
```

---

### 测试 3: 图片 + 文字组合

**步骤：**
1. 先发送图片
2. 再发送文字：`语文作业，详见图片`
3. 查看AI解析结果

---

### 测试 4: 点击确认链接

**长按链接 → 在浏览器中打开**

会打开确认页面：
- 显示所有任务
- 选择学生
- 确认创建

---

## 🔍 第七步：查看日志（调试用）

### 查看服务器日志

**在运行 Flask 应用的终端：**

会看到类似输出：
```
INFO - 收到微信验证请求: signature=xxx, timestamp=xxx
INFO - ✅ 微信签名验证成功
INFO - 收到微信消息: wechat_id=oxxxxxx, msg_type=text
INFO - 文本消息处理成功: 已识别 2 条任务
```

### 查看 API 日志

**访问：**
```
http://192.168.0.113:5001/metrics
```

可以看到系统指标和请求统计

---

## 🎯 第八步：真实场景测试（5分钟）

### 完整流程测试

**1. 在微信群中找到老师消息**

**2. 长按消息 → 转发 → 选择"测试号"**

**3. 查看收到的AI解析结果**

**4. 点击确认链接（长按 → 在浏览器中打开）**

**5. 选择学生并确认**

**6. 查看任务列表**
```
http://192.168.0.113:5001/tasks
```

---

## ⚠️ 常见问题

### Q1: 提交配置时提示"Token验证失败"

**解决：**
1. 检查 `.env` 中的 `WECHAT_TOKEN`
2. 确保与页面填写的 Token 完全一致（区分大小写）
3. 重启 Flask 应用

```bash
# 重启应用
ps aux | grep "python app.py" | grep -v grep | awk '{print $2}' | xargs kill -9
cd /Volumes/data/vibe-coding-projects/jiaxiao
python app.py
```

---

### Q2: 发送消息后没有回复

**排查步骤：**

1. **检查应用是否运行**
   ```bash
   curl http://localhost:5001/health
   ```

2. **查看日志输出**
   - 看是否有错误信息
   - 检查 LLM API Key 是否配置

3. **检查是否关注了测试号**
   - 重新扫描二维码关注

---

### Q3: 点击链接打不开

**原因：** 链接地址可能不正确

**解决：**
1. 确认使用局域网地址：`http://192.168.0.113:5001/confirm?...`
2. 或使用 Cloudflare Tunnel 地址
3. 长按链接 → "在浏览器中打开"

---

### Q4: 如何邀请其他人测试

**步骤：**

1. **在测试号页面找到二维码**
   - 截图二维码
   - 发送给朋友

2. **朋友扫码关注测试号**
   - 关注后可以在用户列表看到

3. **朋友发送消息测试**
   - 发送老师作业
   - 查看AI解析结果

**限制：**
- 测试号最多 100 个用户
- 朋友需要能访问您的服务器地址

---

## 📊 配置成功标志

### ✅ 所有检查项

- [ ] 测试号申请成功
- [ ] .env 文件配置完成
- [ ] 服务器配置提交成功
- [ ] 关注了测试号
- [ ] 发送文本消息收到回复
- [ ] 收到AI解析结果
- [ ] 点击确认链接可以打开
- [ ] 可以选择学生并创建任务
- [ ] 任务列表页面正常显示

---

## 🎉 配置完成！

现在您已经拥有一个**真实可用的微信公众号**！

### 可以做的事情

✅ **个人测试**
- 随时发送老师消息
- 查看AI解析效果
- 测试任务创建流程

✅ **小范围试用**
- 邀请家人朋友关注（最多100人）
- 收集真实使用反馈
- 优化产品体验

✅ **产品演示**
- 向他人展示产品
- 真实的微信交互
- 完整的功能体验

---

## 📞 下一步

### 立即测试

**在微信中给测试号发送：**
```
语文作业：
1. 背诵《山行》古诗
2. 完成练习册第5页
3. 预习下一课
```

**查看AI解析结果！**

---

### 需要帮助？

如果遇到问题，请提供：
1. 错误提示截图
2. 终端日志输出
3. .env 配置内容（隐藏敏感信息）

我会继续帮您解决！🚀
