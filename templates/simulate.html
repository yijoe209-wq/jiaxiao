<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>家校任务助手</title>
    <!-- 微信内浏览器优化 -->
    <meta name="x5-orientation" content="portrait">
    <meta name="x5-fullscreen" content="true">
    <meta name="x5-page-mode" content="app">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">

    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Google Fonts: Noto Sans SC + Inter -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+SC:wght@300;400;500;700&family=Inter:wght@400;500;600&display=swap" rel="stylesheet">

    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: {
                        sans: ['Noto Sans SC', 'Inter', 'sans-serif'],
                    },
                    colors: {
                        // 日式极简 - 只用黑、白、灰
                        zen: {
                            black: '#1a1a1a',
                            dark: '#333333',
                            gray: '#666666',
                            light: '#999999',
                            lighter: '#e5e5e5',
                            bg: '#fafafa',
                            white: '#ffffff',
                        }
                    }
                }
            }
        }
    </script>

    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Noto Sans SC', 'Inter', sans-serif;
            background: #fafafa;
            min-height: 100vh;
        }

        /* 自定义滚动条 */
        ::-webkit-scrollbar {
            width: 8px;
        }

        ::-webkit-scrollbar-track {
            background: #f0f0f0;
            border-radius: 16px;
        }

        ::-webkit-scrollbar-thumb {
            background: #999999;
            border-radius: 16px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: #1a1a1a;
        }

        /* 输入框焦点效果 - 优化版 */
        .input-focus {
            transition: all 0.2s ease;  /* 从 0.3s 改为 0.2s */
        }

        .input-focus:focus {
            border-color: #1a1a1a;  /* 使用新的主色 */
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);  /* 使用新的主色阴影 */
            outline: none;
        }

        /* 卡片悬停效果 */
        .card-hover {
            transition: all 0.3s ease;
        }

        .card-hover:hover {
            transform: translateY(-2px);
            box-shadow: 0 12px 24px rgba(245, 161, 29, 0.15);
        }

        /* 按钮点击效果 */
        .btn-press {
            transition: all 0.15s ease;
        }

        .btn-press:active {
            transform: scale(0.97);
        }

        /* 加载动画 */
        .loading-spinner {
            border: 3px solid #f3f3f3;
            border-top: 3px solid #999999;
            border-radius: 50%;
            width: 24px;
            height: 24px;
            animation: spin 1s linear infinite;
            display: inline-block;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* 图片预览动画 */
        .image-preview-item {
            animation: fadeIn 0.3s ease-out;
        }

        /* 登录遮罩层 */
        #loginOverlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.5);
            backdrop-filter: blur(4px);
            z-index: 9999;
            display: none;
        }

        #loginOverlay.show {
            display: flex;
            align-items: center;
            justify-content: center;
        }

        /* 新增学生模态框 */
        #studentModal {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.5);
            backdrop-filter: blur(4px);
            z-index: 9999;
            display: none;
        }

        #studentModal.show {
            display: flex;
            align-items: center;
            justify-content: center;
        }
    </style>
</head>
<body class="pb-24">
    <div class="max-w-2xl mx-auto px-4 py-6">
        <!-- 头部导航 - 日式极简 -->
        <header class="bg-[#1a1a1a] rounded-2xl p-4 mb-6">
            <div class="flex items-center justify-between mb-4">
                <div class="flex items-center space-x-3">
                    <div class="w-12 h-12 bg-white rounded-xl flex items-center justify-center">
                        <svg class="w-6 h-6 text-[#1a1a1a]" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M12 6.253v13m0-13C10.832 5.477 9.246 5 7.5 5S4.168 5.477 3 6.253v13C4.168 18.477 5.754 18 7.5 18s3.332.477 4.5 1.253m0-13C13.168 5.477 14.754 5 16.5 5c1.747 0 3.332.477 4.5 1.253v13C19.832 18.477 18.247 18 16.5 18c-1.746 0-3.332.477-4.5 1.253"/>
                        </svg>
                    </div>
                    <div>
                        <h1 class="text-xl font-bold text-white">家校任务助手</h1>
                        <p class="text-gray-400 text-sm">智能解析作业 · 轻松管理任务</p>
                    </div>
                </div>
            </div>

            <!-- 导航链接 -->
            <nav class="flex flex-wrap gap-2">
                <a href="/" class="flex-1 min-w-[100px] bg-white/10 text-white px-4 py-2.5 rounded-xl text-sm font-medium hover:bg-white/20 transition-all text-center">
                    <svg class="w-4 h-4 inline-block mr-1.5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2"/>
                    </svg>
                    任务中心
                </a>
                <a href="/students" class="flex-1 min-w-[100px] bg-white/10 text-white px-4 py-2.5 rounded-xl text-sm font-medium hover:bg-white/20 transition-all text-center">
                    <svg class="w-4 h-4 inline-block mr-1.5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M12 4.354a4 4 0 110 5.292M15 21H3v-1a6 6 0 0112 0v1zm0 0h6v-1a6 6 0 00-9-5.197M13 7a4 4 0 11-8 0 4 4 0 018 0z"/>
                    </svg>
                    学生管理
                </a>
            </nav>
        </header>

        <!-- 主输入卡片 - 日式极简 -->
        <div class="bg-white rounded-2xl border border-gray-100 p-6 mb-6">
            <div class="mb-6">
                <div class="flex items-center mb-4">
                    <div class="w-10 h-10 bg-gray-100 rounded-xl flex items-center justify-center mr-3">
                        <svg class="w-5 h-5 text-[#1a1a1a]" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"/>
                        </svg>
                    </div>
                    <div>
                        <h2 class="text-lg font-bold text-[#1a1a1a]">选择学生</h2>
                        <p class="text-gray-500 text-sm">为哪位学生创建任务？</p>
                    </div>
                </div>
                <select id="studentSelect" class="w-full px-4 py-3.5 bg-gray-50 border-2 border-gray-200 rounded-xl text-[#1a1a1a] focus:outline-none focus:border-[#1a1a1a] appearance-none cursor-pointer">
                    <option value="">请选择学生...</option>
                </select>
            </div>

            <div class="mb-6">
                <div class="flex items-center mb-4">
                    <div class="w-10 h-10 bg-gray-100 rounded-xl flex items-center justify-center mr-3">
                        <svg class="w-5 h-5 text-[#1a1a1a]" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"/>
                        </svg>
                    </div>
                    <div>
                        <h2 class="text-lg font-bold text-[#1a1a1a]">粘贴老师消息</h2>
                        <p class="text-gray-500 text-sm">AI 将自动识别任务内容</p>
                    </div>
                </div>
                <textarea
                    id="messageInput"
                    rows="6"
                    placeholder="在这里粘贴老师的作业消息...

例如：
今晚作业：
1. 数学：完成课本第20页练习题，明天提交
2. 语文：背诵古诗三首，后天检查
3. 英语：听写 Unit 3 单词"
                    class="w-full px-4 py-3.5 bg-gray-50 border-2 border-gray-200 rounded-xl text-[#1a1a1a] focus:outline-none focus:border-[#1a1a1a] resize-none"></textarea>
            </div>

            <!-- 图片上传区域 -->
            <div class="mb-6">
                <div class="flex items-center justify-between mb-3">
                    <div class="flex items-center">
                        <div class="w-10 h-10 bg-gray-100 rounded-xl flex items-center justify-center mr-3">
                            <svg class="w-5 h-5 text-[#1a1a1a]" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z"/>
                            </svg>
                        </div>
                        <div>
                            <h2 class="text-lg font-bold text-[#1a1a1a]">添加图片</h2>
                            <p class="text-gray-500 text-sm">作业截图（可选）</p>
                        </div>
                    </div>
                    <span id="imageCount" class="text-sm text-gray-500 bg-gray-100 px-3 py-1 rounded-full">已选 0 张</span>
                </div>

                <div id="imagePreviewContainer" class="grid grid-cols-3 gap-3 mb-3"></div>

                <label class="flex items-center justify-center w-full px-4 py-3 border-2 border-dashed border-gray-300 rounded-xl cursor-pointer hover:border-[#1a1a1a] hover:bg-gray-50 transition-all group">
                    <input type="file" id="imageInput" accept="image/*" multiple class="hidden" onchange="handleImageSelect(event)">
                    <svg class="w-5 h-5 text-gray-400 group-hover:text-[#1a1a1a] mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M3 9a2 2 0 012-2h.93a2 2 0 001.664-.89l.812-1.22A2 2 0 0110.07 4h3.86a2 2 0 011.664.89l.812 1.22A2 2 0 0018.07 7H19a2 2 0 012 2v9a2 2 0 01-2 2H5a2 2 0 01-2-2V9z"/>
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M15 13a3 3 0 11-6 0 3 3 0 016 0z"/>
                    </svg>
                    <span class="text-gray-600 group-hover:text-[#1a1a1a] font-medium">点击选择图片</span>
                </label>
                <p class="text-xs text-gray-400 mt-2 text-center">支持 JPG、PNG 格式，最多 9 张</p>
            </div>

            <!-- 提交按钮 - 日式极简设计 (黑色) -->
            <button onclick="simulateForward()" class="btn-press w-full bg-[#1a1a1a] hover:bg-[#333333] text-white py-4 rounded-xl font-medium text-base transition-all flex items-center justify-center focus:ring-4 focus:ring-gray-500/50 focus:ring-offset-2">
                <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M13 10V3L4 14h7v7l9-11h-7z"/>
                </svg>
                <span>AI 智能解析并创建任务</span>
            </button>

            <!-- 结果展示 - 日式极简 -->
            <div id="result" class="hidden mt-6">
                <div class="bg-gray-50 border-l-4 border-[#1a1a1a] rounded-xl p-5">
                    <div class="flex items-start">
                        <div class="flex-shrink-0">
                            <div class="w-10 h-10 bg-[#1a1a1a] rounded-full flex items-center justify-center">
                                <svg class="w-5 h-5 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"/>
                                </svg>
                            </div>
                        </div>
                        <div class="ml-4 flex-1" id="resultContent"></div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- 登录遮罩层 -->
    <div id="loginOverlay"></div>

    <!-- 新增学生模态框 -->
    <div id="studentModal"></div>

    <!-- 底部收藏提示 -->
    <div class="fixed bottom-0 left-0 right-0 bg-white/95 backdrop-blur-sm border-t-2 border-primary-200 px-4 py-3 shadow-lg animate-slide-up">
        <div class="max-w-2xl mx-auto">
            <div class="flex items-center justify-center">
                <svg class="w-5 h-5 text-[#1a1a1a] mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M9.663 17h4.673M12 3v1m6.364 1.636l-.707.707M21 12h-1M4 12H3m3.343-5.657l-.707-.707m2.828 9.9a5 5 0 117.072 0l-.548.547A3.374 3.374 0 0014 18.469V19a2 2 0 11-4 0v-.531c0-.895-.356-1.754-.988-2.386l-.548-.547z"/></svg>
                <span class="text-sm text-gray-700">
                    <strong class="text-primary-600">收藏到微信</strong>
                    <span class="text-gray-500">下次快速访问 · 点击右上角 ··· → 收藏</span>
                </span>
            </div>
        </div>
    </div>

    <script>
        const API_BASE = window.location.protocol + '//' + window.location.hostname + (window.location.port ? ':' + window.location.port : '');
        let uploadedImages = [];
        let currentUser = null;

        // 页面加载时检查登录状态
        window.addEventListener('DOMContentLoaded', async function() {
            // 检查登录状态
            try {
                const response = await fetch(`${API_BASE}/api/auth/check`);
                const result = await response.json();

                if (!result.loggedIn) {
                    // 未登录，显示登录提示
                    showLoginRequired();
                    return;
                }

                currentUser = result.user;
            } catch (error) {
                console.error('检查登录状态失败:', error);
            }

            // 加载学生列表
            loadStudents();
        });

        // 显示需要登录提示
        function showLoginRequired() {
            const overlay = document.getElementById('loginOverlay');
            overlay.innerHTML = `
                <div class="bg-white rounded-2xl shadow-2xl p-8 max-w-md mx-4 animate-slide-up">
                    <div class="text-center mb-6">
                        <div class="w-16 h-16 bg-primary-100 rounded-full flex items-center justify-center mx-auto mb-4">
                            <svg class="w-12 h-12 text-[#1a1a1a]" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M12 15v2m-6 4h12a2 2 0 002-2v-6a2 2 0 00-2-2H6a2 2 0 00-2 2v6a2 2 0 002 2zm10-10V7a4 4 0 00-8 0v4h8z"/></svg>
                        </div>
                        <h2 class="text-2xl font-bold text-gray-800 mb-2">需要登录</h2>
                        <p class="text-gray-600">请先登录后再使用任务管理功能</p>
                    </div>
                    <a href="/login" class="btn-press block w-full bg-[#1a1a1a] hover:bg-[#333333] text-white py-4 rounded-xl font-bold text-base shadow-md hover:shadow-lg transition-all text-center focus:ring-4 focus:ring-gray-500/50 focus:ring-offset-2">
                        <svg class="w-4 h-4 inline-block mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M11 16l-4-4m0 0l4-4m-4 4h14m-5 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h7a3 3 0 013 3v1"/></svg>立即登录
                    </a>
                    <p class="text-center text-gray-500 text-sm mt-4">
                        还没有账号？<a href="/login" class="text-primary-600 font-medium hover:underline">立即注册</a>
                    </p>
                </div>
            `;
            overlay.classList.add('show');
        }

        // 加载学生列表
        async function loadStudents() {
            try {
                const response = await fetch(`${API_BASE}/api/students`);
                const result = await response.json();

                if (result.success && result.students) {
                    const select = document.getElementById('studentSelect');

                    // 清空选项
                    select.innerHTML = '<option value="">请选择学生...</option>';

                    // 添加现有学生
                    result.students.forEach(student => {
                        const option = document.createElement('option');
                        option.value = student.student_id;
                        option.textContent = `${student.name} ${student.grade ? '· ' + student.grade : ''}`;
                        select.appendChild(option);
                    });

                    // 添加"新增学生"选项
                    const addOption = document.createElement('option');
                    addOption.value = '__add_new__';
                    addOption.textContent = '+ 新增学生';
                    addOption.style.color = '#999999';
                    addOption.style.fontWeight = 'bold';
                    select.appendChild(addOption);

                    // 监听选择变化
                    select.addEventListener('change', function() {
                        if (this.value === '__add_new__') {
                            showAddStudentModal();
                            this.value = ''; // 重置选择
                        }
                    });
                }
            } catch (error) {
                console.error('加载学生列表失败:', error);
            }
        }

        // 显示新增学生模态框
        function showAddStudentModal() {
            const modal = document.getElementById('studentModal');
            modal.innerHTML = `
                <div class="bg-white rounded-2xl shadow-2xl p-6 max-w-md mx-4 animate-slide-up">
                    <div class="flex items-center justify-between mb-6">
                        <h2 class="text-xl font-bold text-gray-800">
                            <svg class="w-4 h-4 inline-block mr-2 text-[#1a1a1a]" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M18 9v3m0 0v3m0-3h3m-3 0h-3m-2-5a4 4 0 11-8 0 4 4 0 018 0zM3 20a6 6 0 0112 0v1H3v-1z"/></svg>新增学生
                        </h2>
                        <button onclick="closeStudentModal()" class="text-gray-400 hover:text-gray-600 transition-colors">
                            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/></svg>
                        </button>
                    </div>

                    <form onsubmit="addStudent(event)">
                        <div class="mb-4">
                            <label class="block text-gray-700 font-semibold mb-2">学生姓名</label>
                            <input type="text" id="newStudentName" required
                                   class="input-focus w-full px-4 py-3 bg-gray-50 border-2 border-gray-200 rounded-xl focus:outline-none"
                                   placeholder="请输入学生姓名">
                        </div>

                        <div class="mb-6">
                            <label class="block text-gray-700 font-semibold mb-2">年级</label>
                            <select id="newStudentGrade"
                                    class="input-focus w-full px-4 py-3 bg-gray-50 border-2 border-gray-200 rounded-xl focus:outline-none">
                                <option value="一年级">一年级</option>
                                <option value="二年级">二年级</option>
                                <option value="三年级">三年级</option>
                                <option value="四年级">四年级</option>
                                <option value="五年级">五年级</option>
                                <option value="六年级">六年级</option>
                                <option value="七年级">七年级</option>
                                <option value="八年级">八年级</option>
                                <option value="九年级">九年级</option>
                            </select>
                        </div>

                        <div class="flex gap-3">
                            <button type="button" onclick="closeStudentModal()"
                                    class="flex-1 px-4 py-3 bg-gray-100 text-gray-700 rounded-xl font-semibold hover:bg-gray-200 transition-all">
                                取消
                            </button>
                            <button type="submit"
                                    class="flex-1 px-4 py-3 bg-[#1a1a1a] hover:bg-[#333333] text-white rounded-xl font-semibold transition-all shadow-md">
                                <svg class="w-4 h-4 inline-block mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"/></svg>添加
                            </button>
                        </div>
                    </form>
                </div>
            `;
            modal.classList.add('show');
        }

        // 关闭新增学生模态框
        function closeStudentModal() {
            const modal = document.getElementById('studentModal');
            modal.classList.remove('show');
        }

        // 添加学生
        async function addStudent(event) {
            event.preventDefault();

            const name = document.getElementById('newStudentName').value.trim();
            const grade = document.getElementById('newStudentGrade').value;

            if (!name) {
                alert('请输入学生姓名');
                return;
            }

            try {
                const response = await fetch(`${API_BASE}/api/students`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ name, grade })
                });

                const result = await response.json();

                if (result.success) {
                    // 关闭模态框
                    closeStudentModal();

                    // 重新加载学生列表
                    await loadStudents();

                    // 自动选择新添加的学生
                    const select = document.getElementById('studentSelect');
                    select.value = result.student_id;

                    // 显示成功提示
                    showToast('学生添加成功！');
                } else {
                    alert('添加失败：' + result.error);
                }
            } catch (error) {
                alert('添加失败：' + error.message);
            }
        }

        // 显示提示消息
        function showToast(message) {
            const toast = document.createElement('div');
            toast.className = 'fixed top-4 right-4 bg-accent-500 text-white px-6 py-3 rounded-xl shadow-lg z-50 animate-slide-up';
            toast.innerHTML = `<svg class="w-4 h-4 inline-block mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"/></svg>${message}`;
            document.body.appendChild(toast);

            setTimeout(() => {
                toast.remove();
            }, 3000);
        }

        // 处理图片选择
        function handleImageSelect(event) {
            const files = event.target.files;
            if (!files || files.length === 0) return;

            const previewContainer = document.getElementById('imagePreviewContainer');

            for (let i = 0; i < files.length; i++) {
                if (uploadedImages.length >= 9) {
                    alert('最多只能上传 9 张图片');
                    break;
                }

                const file = files[i];

                if (file.size > 16 * 1024 * 1024) {
                    alert(`图片 "${file.name}" 超过 16MB，请选择更小的图片`);
                    continue;
                }

                const reader = new FileReader();
                reader.onload = (e) => {
                    const base64 = e.target.result;
                    uploadedImages.push(base64);

                    const previewDiv = document.createElement('div');
                    previewDiv.className = 'image-preview-item relative w-full pb-[100%] overflow-hidden rounded-xl bg-gray-100 shadow-sm';
                    previewDiv.dataset.index = uploadedImages.length - 1;

                    const img = document.createElement('img');
                    img.src = base64;
                    img.className = 'absolute top-0 left-0 w-full h-full object-cover';

                    const removeBtn = document.createElement('button');
                    removeBtn.className = 'absolute top-2 right-2 w-6 h-6 bg-red-500 text-white rounded-full flex items-center justify-center text-sm font-bold hover:bg-red-600 transition-colors shadow-md';
                    removeBtn.innerHTML = '×';
                    removeBtn.onclick = () => removeImage(previewDiv);

                    previewDiv.appendChild(img);
                    previewDiv.appendChild(removeBtn);
                    previewContainer.appendChild(previewDiv);

                    document.getElementById('imageCount').textContent = `已选 ${uploadedImages.length} 张`;
                };
                reader.readAsDataURL(file);
            }

            event.target.value = '';
        }

        // 删除图片
        function removeImage(previewElement) {
            const index = parseInt(previewElement.dataset.index);
            uploadedImages.splice(index, 1);

            const allPreviews = document.querySelectorAll('.image-preview-item');
            allPreviews.forEach((el, idx) => {
                el.dataset.index = idx;
            });

            previewElement.remove();
            document.getElementById('imageCount').textContent = `已选 ${uploadedImages.length} 张`;
        }

        async function simulateForward() {
            const studentId = document.getElementById('studentSelect').value;
            const message = document.getElementById('messageInput').value.trim();

            if (!studentId) {
                alert('请先选择学生\n\n如果没有学生，请先到"学生管理"页面添加');
                return;
            }

            if (!message && uploadedImages.length === 0) {
                alert('请输入老师消息或添加图片');
                return;
            }

            const btn = event.target;
            btn.disabled = true;
            btn.innerHTML = '<div class="loading-spinner mr-2"></div><span>AI 正在解析...</span>';

            try {
                const simulateResponse = await fetch(`${API_BASE}/api/simulate`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        message: message,
                        images: uploadedImages
                    })
                });

                const simulateResult = await simulateResponse.json();

                if (!simulateResult.success) {
                    throw new Error(simulateResult.error || 'AI 解析失败');
                }

                // AI解析成功，跳转到确认页面让用户编辑和确认
                btn.innerHTML = '<div class="loading-spinner mr-2"></div><span>AI 解析完成，跳转到确认页面...</span>';

                setTimeout(() => {
                    window.location.href = `/confirm?pending_id=${simulateResult.pending_id}&student_id=${studentId}`;
                }, 500);

            } catch (error) {
                const resultDiv = document.getElementById('result');
                const contentDiv = document.getElementById('resultContent');
                contentDiv.innerHTML = `
                    <h3 class="text-lg font-bold text-red-600 mb-2">操作失败</h3>
                    <p class="text-gray-600 text-sm">${error.message}</p>
                `;
                resultDiv.classList.remove('hidden');
            } finally {
                btn.disabled = false;
                btn.innerHTML = '<svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M13 10V3L4 14h7v7l9-11h-7z"/></svg><span>AI 智能解析并创建任务</span>';
            }
        }
    </script>
</body>
</html>
