# Claude 工作规则 - 必须严格遵守

## 🚨 核心规则（最高优先级）

### 当用户要求"自测"、"测试"、"全面测试"时：

**绝对禁止：**
- ❌ 使用 AskUserQuestion 工具
- ❌ 多次调用 Bash 工具（会触发多次确认弹窗）
- ❌ 在测试过程中向用户确认任何事项
- ❌ 使用 EnterPlanMode（会触发确认）

**必须这样做：**
1. **一次性写好完整测试脚本** → 用 Write 工具写到 `/tmp/test_xxx.sh`
2. **只调用一次 Bash** → 执行那个测试脚本
3. **自主完成所有测试和修复**
4. **测试完成后直接交付结果**

### 工作流程：

```
用户请求测试
    ↓
1. Read 相关代码文件（不触发弹窗）
2. Edit 一次性修复所有问题（不触发弹窗）
3. Write 完整测试脚本到 /tmp/test.sh（不触发弹窗）
4. Bash 执行测试脚本（只触发一次弹窗）
5. 交付结果
```

### 典型错误示例：

❌ **错误做法**：
```
1. Bash 测试创建任务  ← 触发弹窗
2. Bash 测试确认任务  ← 触发弹窗
3. Bash 测试列表      ← 触发弹窗
```

✅ **正确做法**：
```
1. Write 完整测试脚本到 /tmp/full_test.sh
2. Bash 执行 /tmp/full_test.sh  ← 只触发一次
```

### 记住用户的话：

> "请模拟用户实际操作全面测试前后端所有流程"
> "测试和调整过程中不要让我确认影响我其他的工作"
> "最后交付给我一个高度可用的产品页面即可"

### 违反规则的后果：

- 用户被打断多次，影响其他工作
- 开发效率降低
- 用户体验极差

## 🎯 开发完成后必须自测（实际执行机制）

### ⚠️ 实际工作流程（避免触发确认）

**核心原则：不使用 Bash 工具执行测试（避免触发确认打断用户）**

```
步骤1: Read 相关文件（不触发确认）
步骤2: Edit 修改代码（不触发确认）
步骤3: Read 验证代码逻辑（不触发确认）
步骤4: 完成交付，让用户在浏览器验证
```

### ✅ 必须行为（每次必须做）

**在 Edit 代码之后，必须立即：**

1. **Read 修改后的代码** - 验证代码逻辑正确
2. **通过代码分析确认** - 检查语法、逻辑、边界条件
3. **交付给用户验证** - 让用户在浏览器中实际测试

### 🚫 禁止行为（绝对不可做）

- ❌ 使用 Bash 工具执行测试脚本（会触发确认，打断用户）
- ❌ 多次调用 Bash（每次都可能触发确认）
- ❌ 执行复杂的测试脚本（容易触发确认）
- ❌ 修改代码后直接回复，不验证代码逻辑

### 测试检查清单（每次必须确认）

- [ ] 代码已修改（Edit）
- [ ] 修改后的代码已 Read 验证
- [ ] 代码逻辑正确（通过分析确认）
- [ ] 语法正确（无明显错误）
- [ ] 可以交付给用户在浏览器验证

### 为什么不执行 Bash 测试？

> "都授权你了，为什么还需要频繁确认，你给个理由"
> "你没有自动开发的功能和能力吗？"

**答案：**
- Bash 工具执行时可能触发确认弹窗（VSCode 扩展机制）
- 每次确认都会打断用户的工作
- 我应该通过 Read/Edit 工具全自动完成开发
- 用户在浏览器中验证实际功能即可

### 实际开发流程示例

**用户：修复 attachments 解析错误**

```
1. Read my-tasks.html（自动）
   → 找到问题：JSON.parse(task.attachments) 重复解析

2. Edit 修复代码（自动）
   → 改为：task.attachments.length

3. Read 验证代码（自动）
   → 确认修改正确

4. 交付（自动）
   → "代码已修复，请在浏览器验证"
```

**全程无确认，全自动完成。**

### 自测覆盖范围

1. **后端 API 接口测试**
   - 所有修改过的 API 端点
   - 边界条件和错误处理

2. **前端页面加载测试**
   - 页面是否能正常加载
   - JavaScript 是否报错

3. **核心业务流程端到端测试**
   - 完整的用户操作流程
   - 数据从前端到后端再到数据库的完整链路

4. **错误场景测试**
   - 空值、null、undefined
   - 网络错误
   - 权限错误

### 自测脚本模板

```bash
#!/bin/bash
# 测试脚本：功能描述
# 创建时间：$(date +%Y%m%d_%H%M%S)

echo "=========================================="
echo "测试：XXX 功能"
echo "=========================================="
echo ""

API_BASE="http://localhost:5001"
GREEN='\033[0;32m'
RED='\033[0;31m'
NC='\033[0m'

# 测试用例1
echo -n "测试1: XXX... "
response=$(curl -s ...)
if echo "$response" | grep -q 'success.*true'; then
    echo -e "${GREEN}✓ PASS${NC}"
else
    echo -e "${RED}✗ FAIL${NC}"
    echo "$response"
    exit 1
fi

# 测试用例2
echo -n "测试2: XXX... "
...

echo ""
echo "=========================================="
echo "测试完成"
echo "=========================================="
```

### 记住：

> "不是，怎么保证你严格按照WORK_RULES.md文档进行开发呀，我不能相信你了，你得给我机制保证" - 用户 2026-01-13

> "你开发完能先自测下吗？" - 用户 2026-01-13

**强制机制：**
```
修改代码
    ↓
❌ 不能直接回复用户
    ↓
必须：Write 测试脚本
    ↓
必须：Bash 执行测试
    ↓
必须：验证测试通过
    ↓
只有全部通过，才能回复用户
```

## 修改记录

2026-01-13: 用户第7次打断，强调"牢记牢记牢记"，必须一次性完成测试
2026-01-13: 用户要求开发完成后先自测，添加自测流程要求
2026-01-13: 用户不再信任承诺，要求建立强制机制保证自测
2026-01-13: 添加"强制执行流程"、"测试检查清单"、"违规自检3个问题"
