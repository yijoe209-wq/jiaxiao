<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ğŸ“š å®¶æ ¡ä»»åŠ¡åŠ©æ‰‹</title>
    <!-- å¾®ä¿¡å†…æµè§ˆå™¨ä¼˜åŒ– -->
    <meta name="x5-orientation" content="portrait">
    <meta name="x5-fullscreen" content="true">
    <meta name="x5-page-mode" content="app">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">

    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+SC:wght@400;500;700&display=swap" rel="stylesheet">
    <!-- Font Awesome Icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">

    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        primary: {
                            50: '#fef3e2',
                            100: '#fde9c7',
                            200: '#fbd99b',
                            300: '#f9c66d',
                            400: '#f7b345',
                            500: '#f5a11d',
                            600: '#f48d12',
                            700: '#f37907',
                            800: '#f16501',
                            900: '#ee4600',
                        },
                        accent: {
                            50: '#e8f5e9',
                            100: '#c8e6c9',
                            200: '#a5d6a7',
                            300: '#81c784',
                            400: '#66bb6a',
                            500: '#4caf50',
                            600: '#43a047',
                            700: '#388e3c',
                            800: '#2e7d32',
                            900: '#1b5e20',
                        },
                    },
                    fontFamily: {
                        sans: ['"Noto Sans SC"', 'sans-serif'],
                    },
                    animation: {
                        'fade-in': 'fadeIn 0.5s ease-out',
                        'slide-up': 'slideUp 0.5s ease-out',
                        'bounce-soft': 'bounceSoft 0.6s ease-in-out',
                        'pulse-slow': 'pulse 3s ease-in-out infinite',
                    },
                    keyframes: {
                        fadeIn: {
                            '0%': { opacity: '0' },
                            '100%': { opacity: '1' },
                        },
                        slideUp: {
                            '0%': { transform: 'translateY(20px)', opacity: '0' },
                            '100%': { transform: 'translateY(0)', opacity: '1' },
                        },
                        bounceSoft: {
                            '0%, 100%': { transform: 'translateY(0)' },
                            '50%': { transform: 'translateY(-8px)' },
                        },
                    },
                },
            },
        }
    </script>

    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Noto Sans SC', sans-serif;
            background: linear-gradient(135deg, #fef3e2 0%, #fff9f0 50%, #fef3e2 100%);
            min-height: 100vh;
        }

        /* è‡ªå®šä¹‰æ»šåŠ¨æ¡ */
        ::-webkit-scrollbar {
            width: 8px;
        }

        ::-webkit-scrollbar-track {
            background: #f1f1f1;
            border-radius: 10px;
        }

        ::-webkit-scrollbar-thumb {
            background: #f5a11d;
            border-radius: 10px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: #f48d12;
        }

        /* è¾“å…¥æ¡†ç„¦ç‚¹æ•ˆæœ */
        .input-focus {
            transition: all 0.3s ease;
        }

        .input-focus:focus {
            border-color: #f5a11d;
            box-shadow: 0 0 0 4px rgba(245, 161, 29, 0.1);
        }

        /* å¡ç‰‡æ‚¬åœæ•ˆæœ */
        .card-hover {
            transition: all 0.3s ease;
        }

        .card-hover:hover {
            transform: translateY(-2px);
            box-shadow: 0 12px 24px rgba(245, 161, 29, 0.15);
        }

        /* æŒ‰é’®ç‚¹å‡»æ•ˆæœ */
        .btn-press {
            transition: all 0.15s ease;
        }

        .btn-press:active {
            transform: scale(0.97);
        }

        /* åŠ è½½åŠ¨ç”» */
        .loading-spinner {
            border: 3px solid #f3f3f3;
            border-top: 3px solid #f5a11d;
            border-radius: 50%;
            width: 24px;
            height: 24px;
            animation: spin 1s linear infinite;
            display: inline-block;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* å›¾ç‰‡é¢„è§ˆåŠ¨ç”» */
        .image-preview-item {
            animation: fadeIn 0.3s ease-out;
        }
    </style>
</head>
<body class="pb-24">
    <div class="max-w-2xl mx-auto px-4 py-6">
        <!-- å¤´éƒ¨å¯¼èˆª -->
        <header class="bg-gradient-to-r from-primary-500 to-primary-600 rounded-2xl shadow-lg p-4 mb-6 animate-fade-in">
            <div class="flex items-center justify-between mb-4">
                <div class="flex items-center space-x-3">
                    <div class="w-12 h-12 bg-white rounded-xl flex items-center justify-center shadow-md">
                        <span class="text-2xl">ğŸ“š</span>
                    </div>
                    <div>
                        <h1 class="text-xl font-bold text-white">å®¶æ ¡ä»»åŠ¡åŠ©æ‰‹</h1>
                        <p class="text-primary-100 text-sm">æ™ºèƒ½è§£æä½œä¸š Â· è½»æ¾ç®¡ç†ä»»åŠ¡</p>
                    </div>
                </div>
            </div>

            <!-- å¯¼èˆªé“¾æ¥ -->
            <nav class="flex flex-wrap gap-2">
                <a href="/my-tasks" class="flex-1 min-w-[100px] bg-white/20 backdrop-blur-sm text-white px-4 py-2.5 rounded-xl text-sm font-medium hover:bg-white/30 transition-all text-center">
                    <i class="fas fa-tasks mr-1.5"></i>ä»»åŠ¡ä¸­å¿ƒ
                </a>
                <a href="/students" class="flex-1 min-w-[100px] bg-white/20 backdrop-blur-sm text-white px-4 py-2.5 rounded-xl text-sm font-medium hover:bg-white/30 transition-all text-center">
                    <i class="fas fa-user-graduate mr-1.5"></i>å­¦ç”Ÿç®¡ç†
                </a>
            </nav>
        </header>

        <!-- ä¸»è¾“å…¥å¡ç‰‡ -->
        <div class="bg-white rounded-2xl shadow-lg p-6 mb-6 card-hover animate-slide-up">
            <div class="mb-6">
                <div class="flex items-center mb-4">
                    <div class="w-10 h-10 bg-primary-100 rounded-xl flex items-center justify-center mr-3">
                        <i class="fas fa-user-graduate text-primary-500 text-lg"></i>
                    </div>
                    <div>
                        <h2 class="text-lg font-bold text-gray-800">é€‰æ‹©å­¦ç”Ÿ</h2>
                        <p class="text-gray-500 text-sm">ä¸ºå“ªä½å­¦ç”Ÿåˆ›å»ºä»»åŠ¡ï¼Ÿ</p>
                    </div>
                </div>
                <select id="studentSelect" class="input-focus w-full px-4 py-3.5 bg-gray-50 border-2 border-gray-200 rounded-xl text-gray-800 focus:outline-none appearance-none cursor-pointer">
                    <option value="">ğŸ‘‡ è¯·é€‰æ‹©å­¦ç”Ÿ...</option>
                </select>
            </div>

            <div class="mb-6">
                <div class="flex items-center mb-4">
                    <div class="w-10 h-10 bg-accent-100 rounded-xl flex items-center justify-center mr-3">
                        <i class="fas fa-edit text-accent-500 text-lg"></i>
                    </div>
                    <div>
                        <h2 class="text-lg font-bold text-gray-800">ç²˜è´´è€å¸ˆæ¶ˆæ¯</h2>
                        <p class="text-gray-500 text-sm">AI å°†è‡ªåŠ¨è¯†åˆ«ä»»åŠ¡å†…å®¹</p>
                    </div>
                </div>
                <textarea
                    id="messageInput"
                    rows="6"
                    placeholder="åœ¨è¿™é‡Œç²˜è´´è€å¸ˆçš„ä½œä¸šæ¶ˆæ¯...

ä¾‹å¦‚ï¼š
ä»Šæ™šä½œä¸šï¼š
1. æ•°å­¦ï¼šå®Œæˆè¯¾æœ¬ç¬¬20é¡µç»ƒä¹ é¢˜ï¼Œæ˜å¤©æäº¤
2. è¯­æ–‡ï¼šèƒŒè¯µå¤è¯—ä¸‰é¦–ï¼Œåå¤©æ£€æŸ¥
3. è‹±è¯­ï¼šå¬å†™ Unit 3 å•è¯"
                    class="input-focus w-full px-4 py-3.5 bg-gray-50 border-2 border-gray-200 rounded-xl text-gray-800 focus:outline-none resize-none"></textarea>
            </div>

            <!-- å›¾ç‰‡ä¸Šä¼ åŒºåŸŸ -->
            <div class="mb-6">
                <div class="flex items-center justify-between mb-3">
                    <div class="flex items-center">
                        <div class="w-10 h-10 bg-secondary-100 rounded-xl flex items-center justify-center mr-3">
                            <i class="fas fa-image text-secondary-500 text-lg"></i>
                        </div>
                        <div>
                            <h2 class="text-lg font-bold text-gray-800">æ·»åŠ å›¾ç‰‡</h2>
                            <p class="text-gray-500 text-sm">ä½œä¸šæˆªå›¾ï¼ˆå¯é€‰ï¼‰</p>
                        </div>
                    </div>
                    <span id="imageCount" class="text-sm text-gray-500 bg-gray-100 px-3 py-1 rounded-full">å·²é€‰ 0 å¼ </span>
                </div>

                <div id="imagePreviewContainer" class="grid grid-cols-3 gap-3 mb-3"></div>

                <label class="flex items-center justify-center w-full px-4 py-3 border-2 border-dashed border-gray-300 rounded-xl cursor-pointer hover:border-primary-400 hover:bg-primary-50 transition-all group">
                    <input type="file" id="imageInput" accept="image/*" multiple class="hidden" onchange="handleImageSelect(event)">
                    <i class="fas fa-camera text-gray-400 group-hover:text-primary-500 mr-2 text-lg"></i>
                    <span class="text-gray-600 group-hover:text-primary-600 font-medium">ç‚¹å‡»é€‰æ‹©å›¾ç‰‡</span>
                </label>
                <p class="text-xs text-gray-400 mt-2 text-center">æ”¯æŒ JPGã€PNG æ ¼å¼ï¼Œæœ€å¤š 9 å¼ </p>
            </div>

            <!-- æäº¤æŒ‰é’® -->
            <button onclick="simulateForward()" class="btn-press w-full bg-gradient-to-r from-primary-500 to-primary-600 text-white py-4 rounded-xl font-bold text-base shadow-lg hover:shadow-xl hover:from-primary-600 hover:to-primary-700 transition-all flex items-center justify-center">
                <i class="fas fa-magic mr-2 text-lg"></i>
                <span>AI æ™ºèƒ½è§£æå¹¶åˆ›å»ºä»»åŠ¡</span>
            </button>

            <!-- ç»“æœå±•ç¤º -->
            <div id="result" class="hidden mt-6 animate-slide-up">
                <div class="bg-accent-50 border-l-4 border-accent-500 rounded-xl p-5">
                    <div class="flex items-start">
                        <div class="flex-shrink-0">
                            <div class="w-10 h-10 bg-accent-500 rounded-full flex items-center justify-center">
                                <i class="fas fa-check text-white text-lg"></i>
                            </div>
                        </div>
                        <div class="ml-4 flex-1" id="resultContent"></div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- åº•éƒ¨æ”¶è—æç¤º -->
    <div class="fixed bottom-0 left-0 right-0 bg-white/95 backdrop-blur-sm border-t-2 border-primary-200 px-4 py-3 shadow-lg animate-slide-up">
        <div class="max-w-2xl mx-auto">
            <div class="flex items-center justify-center">
                <i class="fas fa-lightbulb text-primary-500 mr-2 text-lg animate-pulse-slow"></i>
                <span class="text-sm text-gray-700">
                    <strong class="text-primary-600">æ”¶è—åˆ°å¾®ä¿¡</strong>
                    <span class="text-gray-500">ä¸‹æ¬¡å¿«é€Ÿè®¿é—® Â· ç‚¹å‡»å³ä¸Šè§’ Â·Â·Â· â†’ æ”¶è—</span>
                </span>
            </div>
        </div>
    </div>

    <script>
        const API_BASE = window.location.protocol + '//' + window.location.hostname + (window.location.port ? ':' + window.location.port : '');
        let uploadedImages = [];

        // é¡µé¢åŠ è½½æ—¶è·å–å­¦ç”Ÿåˆ—è¡¨
        window.addEventListener('DOMContentLoaded', async function() {
            try {
                const response = await fetch(`${API_BASE}/api/students`);
                const result = await response.json();

                if (result.success && result.students) {
                    const select = document.getElementById('studentSelect');
                    result.students.forEach(student => {
                        const option = document.createElement('option');
                        option.value = student.student_id;
                        option.textContent = `${student.name} ${student.grade ? 'Â· ' + student.grade : ''}`;
                        select.appendChild(option);
                    });
                }
            } catch (error) {
                console.error('åŠ è½½å­¦ç”Ÿåˆ—è¡¨å¤±è´¥:', error);
            }
        });

        // å¤„ç†å›¾ç‰‡é€‰æ‹©
        function handleImageSelect(event) {
            const files = event.target.files;
            if (!files || files.length === 0) return;

            const previewContainer = document.getElementById('imagePreviewContainer');

            for (let i = 0; i < files.length; i++) {
                if (uploadedImages.length >= 9) {
                    alert('æœ€å¤šåªèƒ½ä¸Šä¼  9 å¼ å›¾ç‰‡');
                    break;
                }

                const file = files[i];

                if (file.size > 16 * 1024 * 1024) {
                    alert(`å›¾ç‰‡ "${file.name}" è¶…è¿‡ 16MBï¼Œè¯·é€‰æ‹©æ›´å°çš„å›¾ç‰‡`);
                    continue;
                }

                const reader = new FileReader();
                reader.onload = (e) => {
                    const base64 = e.target.result;
                    uploadedImages.push(base64);

                    const previewDiv = document.createElement('div');
                    previewDiv.className = 'image-preview-item relative w-full pb-[100%] overflow-hidden rounded-xl bg-gray-100 shadow-sm';
                    previewDiv.dataset.index = uploadedImages.length - 1;

                    const img = document.createElement('img');
                    img.src = base64;
                    img.className = 'absolute top-0 left-0 w-full h-full object-cover';

                    const removeBtn = document.createElement('button');
                    removeBtn.className = 'absolute top-2 right-2 w-6 h-6 bg-red-500 text-white rounded-full flex items-center justify-center text-sm font-bold hover:bg-red-600 transition-colors shadow-md';
                    removeBtn.innerHTML = 'Ã—';
                    removeBtn.onclick = () => removeImage(previewDiv);

                    previewDiv.appendChild(img);
                    previewDiv.appendChild(removeBtn);
                    previewContainer.appendChild(previewDiv);

                    document.getElementById('imageCount').textContent = `å·²é€‰ ${uploadedImages.length} å¼ `;
                };
                reader.readAsDataURL(file);
            }

            event.target.value = '';
        }

        // åˆ é™¤å›¾ç‰‡
        function removeImage(previewElement) {
            const index = parseInt(previewElement.dataset.index);
            uploadedImages.splice(index, 1);

            const allPreviews = document.querySelectorAll('.image-preview-item');
            allPreviews.forEach((el, idx) => {
                el.dataset.index = idx;
            });

            previewElement.remove();
            document.getElementById('imageCount').textContent = `å·²é€‰ ${uploadedImages.length} å¼ `;
        }

        async function simulateForward() {
            const studentId = document.getElementById('studentSelect').value;
            const message = document.getElementById('messageInput').value.trim();

            if (!studentId) {
                alert('è¯·å…ˆé€‰æ‹©å­¦ç”Ÿ');
                return;
            }

            if (!message && uploadedImages.length === 0) {
                alert('è¯·è¾“å…¥è€å¸ˆæ¶ˆæ¯æˆ–æ·»åŠ å›¾ç‰‡');
                return;
            }

            const btn = event.target;
            btn.disabled = true;
            btn.innerHTML = '<div class="loading-spinner mr-2"></div><span>AI æ­£åœ¨è§£æ...</span>';

            try {
                const simulateResponse = await fetch(`${API_BASE}/api/simulate`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        message: message,
                        images: uploadedImages
                    })
                });

                const simulateResult = await simulateResponse.json();

                if (!simulateResult.success) {
                    throw new Error(simulateResult.error || 'AI è§£æå¤±è´¥');
                }

                btn.innerHTML = '<div class="loading-spinner mr-2"></div><span>æ­£åœ¨åˆ›å»ºä»»åŠ¡...</span>';

                const confirmResponse = await fetch(`${API_BASE}/api/confirm`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        pending_id: simulateResult.pending_id,
                        student_id: studentId
                    })
                });

                const confirmResult = await confirmResponse.json();

                const resultDiv = document.getElementById('result');
                const contentDiv = document.getElementById('resultContent');

                if (confirmResult.success) {
                    const taskCount = confirmResult.task_count || (confirmResult.task_id ? 1 : 0) || simulateResult.total_tasks;

                    contentDiv.innerHTML = `
                        <h3 class="text-lg font-bold text-accent-700 mb-2">ğŸ‰ æˆåŠŸåˆ›å»º ${taskCount} æ¡ä»»åŠ¡ï¼</h3>
                        <p class="text-gray-600 text-sm mb-4">ä»»åŠ¡å·²æ·»åŠ åˆ°ä»»åŠ¡ä¸­å¿ƒï¼Œå¿«å»æŸ¥çœ‹å§</p>
                        <a href="/my-tasks" class="inline-flex items-center px-6 py-3 bg-accent-500 text-white rounded-xl font-semibold hover:bg-accent-600 transition-colors shadow-md hover:shadow-lg">
                            <i class="fas fa-arrow-right mr-2"></i>
                            æŸ¥çœ‹ä»»åŠ¡ä¸­å¿ƒ
                        </a>
                    `;
                    resultDiv.classList.remove('hidden');

                    document.getElementById('messageInput').value = '';
                    document.getElementById('imagePreviewContainer').innerHTML = '';
                    uploadedImages = [];
                    document.getElementById('imageCount').textContent = 'å·²é€‰ 0 å¼ ';
                    document.getElementById('studentSelect').value = '';
                } else {
                    contentDiv.innerHTML = `
                        <h3 class="text-lg font-bold text-red-600 mb-2">âŒ åˆ›å»ºä»»åŠ¡å¤±è´¥</h3>
                        <p class="text-gray-600 text-sm mb-3">${confirmResult.error}</p>
                        <p class="text-sm text-gray-500">
                            AI è§£æå·²æˆåŠŸï¼Œæ‚¨å¯ä»¥<a href="/confirm?pending_id=${simulateResult.pending_id}" class="text-primary-600 font-medium hover:underline">æ‰‹åŠ¨ç¡®è®¤</a>
                        </p>
                    `;
                    resultDiv.classList.remove('hidden');
                }

            } catch (error) {
                const resultDiv = document.getElementById('result');
                const contentDiv = document.getElementById('resultContent');
                contentDiv.innerHTML = `
                    <h3 class="text-lg font-bold text-red-600 mb-2">âŒ æ“ä½œå¤±è´¥</h3>
                    <p class="text-gray-600 text-sm">${error.message}</p>
                `;
                resultDiv.classList.remove('hidden');
            } finally {
                btn.disabled = false;
                btn.innerHTML = '<i class="fas fa-magic mr-2 text-lg"></i><span>AI æ™ºèƒ½è§£æå¹¶åˆ›å»ºä»»åŠ¡</span>';
            }
        }
    </script>
</body>
</html>
