<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å®¶åº­æˆå‘˜ç®¡ç† - å®¶æ ¡ä»»åŠ¡åŠ©æ‰‹</title>

    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>

    <!-- Google Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+SC:wght@300;400;500;700&family=Inter:wght@400;500;600&display=swap" rel="stylesheet">

    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: {
                        sans: ['"Noto Sans SC"', '"Inter"', 'sans-serif'],
                    },
                    colors: {
                        zen: {
                            bg: '#ffffff',
                            text: '#1a1a1a',
                            textLight: '#999999',
                            border: '#f0f0f0',
                            accent: '#1a1a1a',
                        }
                    }
                }
            }
        }
    </script>

    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Noto Sans SC', 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
            background: #fafafa;
            color: #1a1a1a;
            line-height: 1.6;
            -webkit-font-smoothing: antialiased;
        }

        .btn-primary {
            background: #1a1a1a;
            color: white;
            padding: 12px 24px;
            border-radius: 12px;
            font-size: 14px;
            font-weight: 500;
            border: none;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .btn-primary:hover {
            background: #333;
        }

        .btn-secondary {
            background: white;
            color: #1a1a1a;
            padding: 12px 24px;
            border-radius: 12px;
            font-size: 14px;
            font-weight: 500;
            border: 1px solid #e5e5e5;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .btn-secondary:hover {
            border-color: #1a1a1a;
        }

        .btn-danger {
            background: #ef4444;
            color: white;
            padding: 8px 16px;
            border-radius: 8px;
            font-size: 13px;
            border: none;
            cursor: pointer;
        }

        .btn-danger:hover {
            background: #dc2626;
        }

        .card {
            background: white;
            border-radius: 16px;
            padding: 24px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        }

        .member-item {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 16px;
            background: #fafafa;
            border-radius: 12px;
            margin-bottom: 12px;
            transition: all 0.2s ease;
        }

        .member-item:hover {
            background: #f5f5f5;
        }

        .role-badge {
            display: inline-block;
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 500;
        }

        .role-admin {
            background: #fef3c7;
            color: #92400e;
        }

        .role-member {
            background: #e5e7eb;
            color: #374151;
        }

        .hidden {
            display: none !important;
        }

        .loading {
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 40px;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        .spinner {
            border: 3px solid #f3f3f3;
            border-top: 3px solid #1a1a1a;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
        }
    </style>
</head>
<body class="min-h-screen">
    <!-- é¡¶éƒ¨å¯¼èˆª -->
    <nav class="bg-white border-b border-gray-200">
        <div class="max-w-4xl mx-auto px-4 py-4 flex items-center justify-between">
            <div class="flex items-center space-x-4">
                <a href="/my-tasks" class="text-gray-600 hover:text-gray-900">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"></path>
                    </svg>
                </a>
                <h1 class="text-xl font-semibold">ğŸ‘¨â€ğŸ‘©â€ğŸ‘§â€ğŸ‘¦ å®¶åº­æˆå‘˜ç®¡ç†</h1>
            </div>
            <div class="flex items-center space-x-4">
                <span id="currentUser" class="text-sm text-gray-600"></span>
                <button onclick="logout()" class="text-sm text-gray-600 hover:text-gray-900">é€€å‡º</button>
            </div>
        </div>
    </nav>

    <!-- ä¸»å†…å®¹ -->
    <main class="max-w-4xl mx-auto px-4 py-8">
        <!-- å½“å‰å®¶åº­ä¿¡æ¯ -->
        <div class="card mb-8">
            <h2 class="text-lg font-semibold mb-2">å½“å‰å®¶åº­</h2>
            <p class="text-gray-600 text-sm">æ‰€æœ‰å®¶åº­æˆå‘˜éƒ½å¯ä»¥æŸ¥çœ‹å’Œç®¡ç†å­©å­çš„ä»»åŠ¡</p>
        </div>

        <!-- å®¶åº­æˆå‘˜åˆ—è¡¨ -->
        <div class="card mb-8">
            <h2 class="text-lg font-semibold mb-4">å®¶åº­æˆå‘˜</h2>

            <div id="membersList" class="loading">
                <div class="spinner"></div>
            </div>

            <div id="emptyState" class="hidden text-center py-12 text-gray-500">
                <p>æš‚æ— å®¶åº­æˆå‘˜</p>
            </div>
        </div>

        <!-- æ·»åŠ æˆå‘˜è¡¨å• -->
        <div class="card">
            <h2 class="text-lg font-semibold mb-4">æ·»åŠ å®¶åº­æˆå‘˜</h2>

            <div id="addMemberForm">
                <p class="text-sm text-gray-600 mb-4">
                    è¯·è¾“å…¥æˆå‘˜çš„é‚®ç®±åœ°å€ï¼š
                </p>

                <form onsubmit="addMember(event)">
                    <div class="mb-4">
                        <input
                            type="email"
                            id="memberEmail"
                            placeholder="æˆå‘˜é‚®ç®±ï¼ˆå¦‚ï¼šmom@example.comï¼‰"
                            required
                            class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-gray-200"
                        >
                    </div>

                    <button type="submit" class="btn-primary w-full">
                        æ‹‰å…¥å®¶åº­
                    </button>
                </form>

                <div class="mt-6 p-4 bg-blue-50 rounded-lg">
                    <p class="text-sm text-blue-800 font-medium mb-2">
                        ğŸ’¡ ä½¿ç”¨è¯´æ˜
                    </p>
                    <ul class="text-sm text-blue-700 list-disc list-inside space-y-1">
                        <li>å¦‚æœæˆå‘˜å·²æ³¨å†Œï¼Œå°†ç›´æ¥æ‹‰å…¥å®¶åº­</li>
                        <li>å¦‚æœæˆå‘˜æœªæ³¨å†Œï¼Œè¯·å…ˆè®©æˆå‘˜æ³¨å†Œè´¦å·</li>
                        <li>æ‹‰å…¥åï¼Œæˆå‘˜å¯ä»¥çœ‹åˆ°å®¶åº­ä¸­æ‰€æœ‰çš„å­©å­å’Œä»»åŠ¡</li>
                    </ul>
                </div>
            </div>
        </div>

        <!-- æç¤ºä¿¡æ¯ -->
        <div class="mt-8 p-4 bg-yellow-50 rounded-lg">
            <p class="text-sm text-yellow-800">
                âš ï¸ <strong>æ³¨æ„ï¼š</strong>åªæœ‰ç®¡ç†å‘˜å¯ä»¥æ·»åŠ å’Œç§»é™¤å®¶åº­æˆå‘˜
            </p>
        </div>
    </main>

    <script>
        // å½“å‰ç”¨æˆ·ä¿¡æ¯
        let currentUser = null;
        let currentRole = null;

        // é¡µé¢åŠ è½½æ—¶æ‰§è¡Œ
        document.addEventListener('DOMContentLoaded', async () => {
            await checkAuth();
            if (currentUser) {
                await loadMembers();
            }
        });

        // æ£€æŸ¥ç™»å½•çŠ¶æ€
        async function checkAuth() {
            try {
                const response = await fetch('/api/auth/check', { credentials: 'same-origin' });
                if (!response.ok) {
                    window.location.href = '/login';
                    return false;
                }

                const data = await response.json();
                currentUser = data;
                currentRole = data.role || 'member';

                document.getElementById('currentUser').textContent = data.parent_name || 'ç”¨æˆ·';
                return true;
            } catch (error) {
                console.error('æ£€æŸ¥ç™»å½•çŠ¶æ€å¤±è´¥:', error);
                window.location.href = '/login';
                return false;
            }
        }

        // åŠ è½½å®¶åº­æˆå‘˜åˆ—è¡¨
        async function loadMembers() {
            try {
                const response = await fetch('/api/family/members', { credentials: 'same-origin' });
                if (!response.ok) {
                    throw new Error('åŠ è½½å¤±è´¥');
                }

                const data = await response.json();
                const members = data.members || [];

                const container = document.getElementById('membersList');
                const emptyState = document.getElementById('emptyState');

                if (members.length === 0) {
                    container.classList.add('hidden');
                    emptyState.classList.remove('hidden');
                    return;
                }

                container.classList.remove('hidden');
                emptyState.classList.add('hidden');

                container.innerHTML = members.map(member => {
                    const isAdmin = member.role === 'admin';
                    const isCurrentUser = currentUser && member.parent_id === currentUser.parent_id;

                    return `
                        <div class="member-item">
                            <div class="flex-1">
                                <div class="flex items-center space-x-3">
                                    <div class="w-10 h-10 bg-gray-200 rounded-full flex items-center justify-center">
                                        <span class="text-gray-600 font-medium">
                                            ${member.name ? member.name.charAt(0).toUpperCase() : '?'}
                                        </span>
                                    </div>
                                    <div>
                                        <div class="font-medium">${member.name || 'æœªçŸ¥'}</div>
                                        <div class="text-sm text-gray-500">${member.email}</div>
                                    </div>
                                </div>
                            </div>
                            <div class="flex items-center space-x-2">
                                <span class="role-badge ${isAdmin ? 'role-admin' : 'role-member'}">
                                    ${isAdmin ? 'ç®¡ç†å‘˜' : 'æˆå‘˜'}
                                </span>
                                ${currentRole === 'admin' && !isAdmin && !isCurrentUser ? `
                                    <button
                                        onclick="removeMember('${member.parent_id}', '${member.name}')"
                                        class="btn-danger text-xs"
                                    >
                                        ç§»é™¤
                                    </button>
                                ` : ''}
                            </div>
                        </div>
                    `;
                }).join('');

            } catch (error) {
                console.error('åŠ è½½å®¶åº­æˆå‘˜å¤±è´¥:', error);
                const container = document.getElementById('membersList');
                container.innerHTML = `
                    <div class="text-center py-12 text-red-600">
                        <p>åŠ è½½å¤±è´¥ï¼Œè¯·åˆ·æ–°é‡è¯•</p>
                    </div>
                `;
            }
        }

        // æ·»åŠ æˆå‘˜ï¼ˆæ‹‰å…¥å®¶åº­ï¼‰
        async function addMember(event) {
            event.preventDefault();

            const email = document.getElementById('memberEmail').value.trim();
            const submitButton = event.target.querySelector('button[type="submit"]');
            const originalText = submitButton.textContent;

            try {
                submitButton.disabled = true;
                submitButton.textContent = 'å¤„ç†ä¸­...';

                const response = await fetch('/api/family/members', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    credentials: 'same-origin',
                    body: JSON.stringify({email})
                });

                const data = await response.json();

                if (data.success) {
                    alert('âœ… ' + data.message);
                    document.getElementById('memberEmail').value = '';
                    await loadMembers();
                } else if (data.needs_register) {
                    alert('â„¹ï¸ ' + data.message + '\n\n' + (data.hint || ''));
                } else {
                    alert('âŒ ' + data.error);
                }

            } catch (error) {
                console.error('æ·»åŠ æˆå‘˜å¤±è´¥:', error);
                alert('âŒ ç½‘ç»œé”™è¯¯ï¼Œè¯·é‡è¯•');
            } finally {
                submitButton.disabled = false;
                submitButton.textContent = originalText;
            }
        }

        // ç§»é™¤æˆå‘˜
        async function removeMember(parentId, memberName) {
            if (!confirm(`ç¡®å®šè¦ç§»é™¤ ${memberName} å—ï¼Ÿ\n\nç§»é™¤åï¼Œè¯¥æˆå‘˜å°†æ— æ³•æŸ¥çœ‹å®¶åº­ä¸­çš„å­©å­å’Œä»»åŠ¡ã€‚`)) {
                return;
            }

            try {
                const response = await fetch(`/api/family/members/${parentId}`, {
                    method: 'DELETE',
                    credentials: 'same-origin'
                });

                const data = await response.json();

                if (data.success) {
                    alert('âœ… ' + data.message);
                    await loadMembers();
                } else {
                    alert('âŒ ' + data.error);
                }

            } catch (error) {
                console.error('ç§»é™¤æˆå‘˜å¤±è´¥:', error);
                alert('âŒ ç½‘ç»œé”™è¯¯ï¼Œè¯·é‡è¯•');
            }
        }

        // é€€å‡ºç™»å½•
        async function logout() {
            if (!confirm('ç¡®å®šè¦é€€å‡ºç™»å½•å—ï¼Ÿ')) {
                return;
            }

            try {
                await fetch('/api/logout', {method: 'POST', credentials: 'same-origin'});
                window.location.href = '/login';
            } catch (error) {
                console.error('é€€å‡ºå¤±è´¥:', error);
                window.location.href = '/login';
            }
        }
    </script>
</body>
</html>
